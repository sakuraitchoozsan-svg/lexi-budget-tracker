<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lexi‚Äôs Budget Tracker üêæ</title>

  <!-- Tailwind (fast dev CDN) & Chart.js -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --pink:#ff89b8; --pink-deep:#d62f6b; --muted:#6b7280; --kitten-bg:#fff6fb;
    }
    html,body{height:100%}
    body{
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin:0; background: radial-gradient(1200px 600px at 10% 10%, #fff6fb 0%, #fff0f6 20%, #fff 60%);
      -webkit-font-smoothing:antialiased; color:#3b2b33;
    }

    header{ padding:1rem 0; border-bottom:1px solid rgba(214,47,107,0.06) }
    .card{ background: linear-gradient(180deg,#ffffff,#fff7fb); border-radius:1rem; padding:1rem; box-shadow:0 12px 36px rgba(198,92,148,0.06); border:1px solid rgba(198,92,148,0.04) }
    .tab-btn{ padding:.5rem .75rem; border-radius:12px; font-weight:700; cursor:pointer; transition: transform .14s ease, box-shadow .14s ease }
    .tab-btn:hover{ transform: translateY(-3px) }
    .tab-btn.active{ background:linear-gradient(90deg,#ffd6e8,#ffc3df); color:#5b0b3a; box-shadow:0 12px 28px rgba(198,92,148,0.08) }
    .floating-paw{ position:fixed; pointer-events:none; font-size:30px; opacity:.14; transform:translate(-50%,-50%); filter: blur(.4px); z-index:9 }
    .modal-backdrop{ position:fixed; inset:0; background:rgba(11,10,11,0.45); display:none; align-items:center; justify-content:center; padding:1rem; z-index:80 }
    .modal-backdrop.open{ display:flex }
    .modal{ background:linear-gradient(180deg,#fff,#fff7fb); border-radius:1rem; padding:1rem; width:100%; max-width:760px; border:1px solid rgba(0,0,0,0.04) }
    .btn{ background:var(--pink); color:white; padding:.5rem .75rem; border-radius:.6rem; border:0; font-weight:800; cursor:pointer; }
    .btn-outline{ background:transparent; border:1px solid var(--pink); color:var(--pink); padding:.5rem .75rem; border-radius:.6rem; font-weight:700; cursor:pointer; }
    .small{ font-size:.86rem; color:var(--muted) }
    .hist-row{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:.6rem; border-radius:.75rem; background:linear-gradient(90deg,#fff,#fff6f9); border:1px solid rgba(198,92,148,0.04) }
    .hist-meta{ font-weight:700; color:#4a2033; }
    table { width:100%; border-collapse:collapse; }
    thead th{ text-align:left; font-weight:800; padding:.5rem; color:#4a2033; font-size:.9rem }
    tbody td{ padding:.5rem; border-top:1px solid rgba(0,0,0,0.03) }
    footer{ padding:1rem; text-align:center; color:var(--muted); font-size:.85rem }
    @media(min-width:900px){ .md-grid-3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:1rem } }
    .quote{ font-style:italic; color:var(--pink-deep) }
    .badge-due{ display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .5rem; border-radius:.6rem; background:linear-gradient(90deg,#ffd6e8,#ffb3d6); color:var(--pink-deep); font-weight:700 }
    .blink{ animation:blink 1s step-start infinite }
    @keyframes blink{50%{opacity:.25}}
  </style>
</head>

<body>
  <!-- Kitten chime (precache target) -->
  <audio id="kitten-chime" preload="auto"><source src="/assets/kitten-chime.mp3" type="audio/mpeg"></audio>

  <!-- floating paw container (decorative) -->
  <div id="paw-layer" aria-hidden="true"></div>

  <header>
    <div class="max-w-6xl mx-auto flex items-center justify-between px-4">
      <div class="flex items-center gap-3">
        <div style="font-size:32px">üê±</div>
        <div>
          <div style="font-weight:900; font-size:18px; color:var(--pink-deep)">Lexi ‚Äî Budget Tracker üêæ</div>
          <div class="small">Pastel kitten budgeting ‚Ä¢ Philippines (‚Ç±) ‚Ä¢ Asia/Manila</div>
        </div>
        <div id="due-badge" class="badge-due ml-4 hidden" style="cursor:pointer"></div>
      </div>

      <div class="flex items-center gap-4">
        <div id="manila-clock" class="small font-mono text-pink-700"></div>
        <div id="davao-weather" class="small"></div>
        <div id="phil-holiday" class="small"></div>
        <button id="sound-toggle" class="btn-outline small">üîî Sound</button>
      </div>
    </div>

    <nav class="max-w-6xl mx-auto mt-4 px-4 flex gap-2 overflow-x-auto">
      <button class="tab-btn active" data-tab="dashboard">Overview</button>
      <button class="tab-btn" data-tab="quick-setup">Quick Setup</button>
      <button class="tab-btn" data-tab="transactions">Transactions</button>
      <button class="tab-btn" data-tab="budgets">Monthly Budget</button>
      <button class="tab-btn" data-tab="savings">Savings & Goals</button>
      <button class="tab-btn" data-tab="salary">Live Salary Tracker</button>
      <button class="tab-btn" data-tab="calendar">Calendar</button>
      <button class="tab-btn" data-tab="reports">Reports</button>
      <button class="tab-btn" data-tab="settings">Settings</button>
    </nav>
  </header>

  <main class="max-w-6xl mx-auto p-6 space-y-6">
    <!-- Dashboard -->
    <section id="panel-dashboard" class="card md-grid-3">
      <div>
        <h3 style="font-weight:900">Welcome ‚Äî Dashboard</h3>
        <p class="quote" id="motivational-quote">Keep going, Lexi! üêæ</p>

        <div class="mt-4 space-y-2">
          <div class="hist-row">
            <div><div class="muted">Running Pay Period</div><div class="hist-meta" id="running-pay-period">‚Ç±0.00</div></div>
            <div><div class="muted">Balance</div><div class="hist-meta" id="balance">‚Ç±0.00</div></div>
          </div>
          <div class="hist-row">
            <div><div class="muted">Monthly Income</div><div class="hist-meta" id="running-monthly-income">‚Ç±0.00</div></div>
            <div><div class="muted">Total Savings</div><div class="hist-meta" id="total-savings">‚Ç±0.00</div></div>
          </div>

          <div class="mt-3 small" id="panel-recent-tx">No transactions</div>
        </div>
      </div>

      <div>
        <h4 style="font-weight:800">Charts</h4>
        <canvas id="chart-monthly" height="180"></canvas>
        <div class="mt-3 small">Monthly / Bi-weekly / Yearly</div>
      </div>

      <div>
        <h4 style="font-weight:800">Quick Actions</h4>
        <div class="mt-3 flex flex-col gap-3">
          <button id="add-tx-btn" class="btn">Add Transaction</button>
          <button id="add-job-btn" class="btn-outline">Add Job</button>
          <button id="sync-paycheck-btn" class="btn-outline">Sync Paycheck</button>
          <div class="mt-2 small">Autosave ‚Ä¢ Offline-first ‚Ä¢ Backup/Restore</div>
        </div>
      </div>
    </section>

    <!-- Quick Setup -->
    <section id="panel-quick-setup" class="card hidden">
      <h3 style="font-weight:900">Quick Setup ‚Äî Jobs & Bills</h3>
      <div class="mt-3 grid md:grid-cols-2 gap-4">
        <div>
          <h4 class="small muted">Jobs</h4>
          <div id="jobs-quick" class="mt-2"></div>
        </div>
        <div>
          <h4 class="small muted">Bills</h4>
          <div id="bills-quick" class="mt-2"></div>
        </div>
      </div>
    </section>

    <!-- Transactions -->
    <section id="panel-transactions" class="card hidden">
      <div class="flex items-center justify-between">
        <h3 style="font-weight:900">Income & Expenses Log</h3>
        <div class="small">Filters: <input id="tx-filter" placeholder="search or date range" class="border rounded px-2 py-1"></div>
      </div>

      <div class="mt-4 overflow-x-auto">
        <table id="tx-table">
          <thead><tr><th>Date</th><th>Description</th><th>Category</th><th>Amount</th><th>Balance</th><th>Linked</th><th>Notes</th><th>Tags</th><th>Status</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Monthly Budget -->
    <section id="panel-budgets" class="card hidden">
      <h3 style="font-weight:900">Monthly Budget</h3>
      <div id="budget-rows" class="mt-3 space-y-2"></div>
    </section>

    <!-- Savings -->
    <section id="panel-savings" class="card hidden">
      <h3 style="font-weight:900">Savings & Goals</h3>
      <div id="savings-list" class="mt-3 space-y-3"></div>
    </section>

    <!-- Salary Tracker -->
    <section id="panel-salary" class="card hidden">
      <h3 style="font-weight:900">Live Salary Tracker</h3>
      <div class="mt-3 grid md:grid-cols-2 gap-4">
        <div id="salary-jobs-list"></div>
        <div>
          <h4 class="small muted">Paystub Preview</h4>
          <div id="paystub-preview" class="mt-2"></div>
          <div id="paycheck-compare" class="mt-2 small muted"></div>
          <div class="mt-3 flex gap-2">
            <select id="salary-range" class="border rounded px-2 py-1 small"><option value="monthly">Monthly</option><option value="biweekly">Bi-weekly</option><option value="weekly">Weekly</option></select>
            <button id="compute-paycheck-btn" class="btn">Compute</button>
            <button id="sync-paycheck-btn2" class="btn-outline">Sync Paycheck</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Calendar -->
    <section id="panel-calendar" class="card hidden">
      <div class="flex items-center gap-2">
        <button id="prev-month" class="btn-outline">‚Äπ</button>
        <div id="calendar-month-label" class="font-medium"></div>
        <button id="next-month" class="btn-outline">‚Ä∫</button>
        <div class="ml-auto small">Timezone: Asia/Manila</div>
      </div>
      <div id="calendar-grid" class="grid grid-cols-7 gap-2 mt-3"></div>
      <div id="calendar-events" class="mt-3"></div>
    </section>

    <!-- Reports -->
    <section id="panel-reports" class="card hidden">
      <h3 style="font-weight:900">Reports & Analytics</h3>
      <div class="mt-3"><canvas id="chart-trends" height="160"></canvas></div>
    </section>

    <!-- Settings -->
    <section id="panel-settings" class="card hidden">
      <h3 style="font-weight:900">Settings & Backup</h3>
      <div class="mt-3 grid md:grid-cols-2 gap-4">
        <div>
          <h4 class="small muted">Export / Import</h4>
          <div class="mt-2 flex gap-2">
            <button id="export-json" class="btn">Export JSON</button>
            <button id="import-json" class="btn-outline">Import JSON</button>
            <button id="backup-btn" class="btn-outline">Encrypted Backup</button>
            <button id="restore-btn" class="btn-outline">Restore Backup</button>
          </div>
        </div>
        <div>
          <h4 class="small muted">Defaults</h4>
          <div class="mt-2 small">Currency: <select id="setting-currency" class="border rounded px-2 py-1 small"><option>‚Ç±</option></select><br>Avg workdays: <input id="setting-workdays" type="number" value="22" class="border rounded px-2 py-1 small" style="width:90px"></div>
        </div>
      </div>
    </section>
  </main>

  <footer>Lexi ‚Äî Pastel Pink Kitten Budget Tracker ‚Ä¢ Asia/Manila timezone</footer>

  <!-- Modals: Transaction / Job / Event (IDs preserved from your doc so handlers work) -->
  <div id="modal-transaction" class="modal-backdrop hidden"><div class="modal">
    <h3 class="font-semibold">Add / Edit Transaction</h3>
    <div class="mt-2 grid gap-2">
      <input id="tx-form-date" type="date" class="border rounded px-2 py-1">
      <input id="tx-form-desc" placeholder="Description" class="border rounded px-2 py-1">
      <input id="tx-form-cat" placeholder="Category" class="border rounded px-2 py-1">
      <input id="tx-form-amt" placeholder="Amount" type="number" class="border rounded px-2 py-1">
      <textarea id="tx-form-notes" placeholder="Notes" class="border rounded px-2 py-1"></textarea>
      <input id="tx-form-tags" placeholder="tags (comma separated)" class="border rounded px-2 py-1">
      <select id="tx-form-status" class="border rounded px-2 py-1"><option value="planned">Planned</option><option value="actual">Actual</option></select>
      <div class="flex justify-between mt-3">
        <div><button id="tx-cancel-btn" class="btn-outline">Cancel</button><button id="tx-delete-btn" class="btn-outline text-red-600 hidden">Delete</button></div>
        <button id="tx-save-btn" class="btn">Save</button>
      </div>
    </div>
  </div></div>

  <div id="modal-job" class="modal-backdrop hidden"><div class="modal">
    <h3 class="font-semibold">Add / Edit Job</h3>
    <div class="mt-2 grid gap-2">
      <input id="job-form-company" placeholder="Company" class="border rounded px-2 py-1">
      <input id="job-form-role" placeholder="Role" class="border rounded px-2 py-1">
      <input id="job-form-salary" placeholder="Monthly salary" type="number" class="border rounded px-2 py-1">
      <select id="job-form-paycycle" class="border rounded px-2 py-1"><option value="monthly">Monthly</option><option value="biweekly">Bi-weekly</option><option value="weekly">Weekly</option></select>
      <div class="flex justify-between mt-3"><div><button id="job-cancel-btn" class="btn-outline">Cancel</button><button id="job-delete-btn" class="btn-outline text-red-600 hidden">Delete</button></div><button id="job-save-btn" class="btn">Save</button></div>
    </div>
  </div></div>

  <div id="modal-event" class="modal-backdrop hidden"><div class="modal">
    <h3 class="font-semibold">Add / Edit Event</h3>
    <div class="mt-2 grid gap-2">
      <input id="event-form-title" placeholder="Title" class="border rounded px-2 py-1">
      <textarea id="event-form-notes" placeholder="Notes" class="border rounded px-2 py-1"></textarea>
      <input id="event-form-date" type="date" class="border rounded px-2 py-1">
      <div class="flex justify-between mt-3"><div><button id="event-delete-btn" class="btn-outline text-red-600 hidden">Delete</button></div><div class="flex gap-2"><button id="event-cancel-btn" class="btn-outline">Cancel</button><button id="event-save-btn" class="btn">Save</button></div></div>
    </div>
  </div></div>

  <!-- Toast area -->
  <div id="toast-area" style="position:fixed; right:16px; bottom:16px; z-index:9999"></div>

  <!-- Main app script: logic derived from your uploaded doc (IndexedDB autosave, undo/redo, charts, calendar, pay period logic, broadcasts, notifications) -->
  <script>
  /*
    Full Lexi app script ‚Äî derived from your uploaded doc (I preserved key IDs and logic):
    - IndexedDB autosave (state saved under key 'state')
    - Undo/Redo stacks, BroadcastChannel cross-tab sync
    - Open-Meteo weather for Davao + Nager.Date holidays for PH
    - AES-GCM encrypted backup/restore
    - Pay period / biweekly cutoff logic
    - Chart.js charts (monthly/trends)
    - Calendar events with emoji mapping and 9:00 AM Manila notifications
    - Service worker registration and handling messages (play-chime, background-sync)
    Source doc: scanned and used as canonical reference. :contentReference[oaicite:3]{index=3} :contentReference[oaicite:4]{index=4}
  */

  (function(){
    const TZ = 'Asia/Manila';
    const DB_NAME='lexi_db_v1', DB_STORE='lexi_store_v1';
    const DEBOUNCE_MS = 800;
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    // State
    let state = { jobs:[], transactions:[], bills:[], budgets:[], savings:[], events:[] };
    let db = null;

    // IndexedDB helpers (preserved)
    function openDB(){ return new Promise((res,rej)=>{ const r = indexedDB.open(DB_NAME,1); r.onupgradeneeded=e=>{ const d = e.target.result; d.createObjectStore(DB_STORE); }; r.onsuccess=e=>{ db=e.target.result; res(); }; r.onerror=rej; }); }
    async function idbPut(key,value){ if(!db) await openDB(); return new Promise((res,rej)=>{ const tx = db.transaction(DB_STORE,'readwrite'); const st = tx.objectStore(DB_STORE); const rq = st.put({val:value}, key); rq.onsuccess = ()=>res(); rq.onerror = (e)=>rej(e); }); }
    async function idbGet(key){ if(!db) await openDB(); return new Promise((res,rej)=>{ const tx = db.transaction(DB_STORE,'readonly'); const st = tx.objectStore(DB_STORE); const rq = st.get(key); rq.onsuccess = ()=> res(rq.result ? rq.result.val : null); rq.onerror = (e)=>rej(e); }); }

    // Undo/Redo
    const UNDO_LIMIT=100; let undoStack=[], redoStack=[];
    function pushUndo(){ undoStack.push(JSON.parse(JSON.stringify(state))); if(undoStack.length>UNDO_LIMIT) undoStack.shift(); redoStack=[]; }
    function undo(){ if(!undoStack.length) return; redoStack.push(JSON.parse(JSON.stringify(state))); state = undoStack.pop(); applyStateToUI(); broadcastState(); idbPut('state', state); }
    function redo(){ if(!redoStack.length) return; undoStack.push(JSON.parse(JSON.stringify(state))); state = redoStack.pop(); applyStateToUI(); broadcastState(); idbPut('state', state); }

    // BroadcastChannel cross-tab sync
    let bc = null;
    try{ bc = new BroadcastChannel('lexi_channel'); bc.onmessage = ev => {
      if(ev.data?.type==='state'){ state = ev.data.state; applyStateToUI(); }
      if(ev.data?.type==='sw-update'){ showUpdateBanner(); }
      if(ev.data?.type==='play-chime'){ playChimeIfAllowed(); }
    }; }catch(e){ bc=null; }
    function broadcastState(){ if(bc) bc.postMessage({type:'state', state}); }

    // Small UI helpers
    function toast(msg, t=2400){ const d=document.createElement('div'); d.className='card small'; d.style.marginTop='8px'; d.textContent=msg; $('#toast-area').appendChild(d); setTimeout(()=> d.remove(), t); }
    function currencyFmt(v){ if(!v && v!==0) return '0.00'; return Number(v).toLocaleString('en-PH',{minimumFractionDigits:2, maximumFractionDigits:2}); }
    function todayISO(){ return new Date(new Date().toLocaleString('en-PH',{timeZone:TZ})).toISOString().slice(0,10); }
    function formatDDMMYYYY(iso){ if(!iso) return ''; const d = new Date(iso); return d.toLocaleDateString('en-PH'); }

    // Apply state UI renderers (excerpts adapted from doc)
    function applyStateToUI(){
      renderTransactionsTable();
      renderBillsList();
      renderJobsQuick();
      renderSalaryUI();
      renderBudgets();
      renderSavings();
      renderCalendar();
      renderDashboard();
      checkDueBadge();
    }

    // Dashboard renderer (from doc)
    function renderDashboard(){
      const income = state.transactions.filter(t=>t.type==='income').reduce((s,t)=>s+Number(t.amt||0),0);
      const expenses = state.transactions.filter(t=>t.type==='expense').reduce((s,t)=>s+Number(t.amt||0),0);
      $('#running-monthly-income').textContent = `${$('#setting-currency').value||'‚Ç±'}${currencyFmt(income)}`;
      $('#total-expenses').textContent = `${$('#setting-currency').value||'‚Ç±'}${currencyFmt(expenses)}`;
      $('#balance').textContent = `${$('#setting-currency').value||'‚Ç±'}${currencyFmt(income-expenses)}`;
      const totalSavings = state.savings.reduce((s,x)=>s+Number(x.current||0),0);
      $('#total-savings').textContent = `${$('#setting-currency').value||'‚Ç±'}${currencyFmt(totalSavings)}`;
      $('#savings-rate').textContent = state.savings.length?`${Math.round(totalSavings/Math.max(1,state.savings.reduce((s,x)=>s+Number(x.target||0),0))*100)}%`:'0%';
      $('#active-job-info') && ($('#active-job-info').textContent = state.jobs[0]?`${state.jobs[0].company} ‚Ä¢ ${state.jobs[0].role} ‚Ä¢ ${$('#setting-currency').value||'‚Ç±'}${currencyFmt(state.jobs[0].salary)}`:'No active job');
      $('#panel-recent-tx') && ($('#panel-recent-tx').innerHTML = state.transactions.slice().sort((a,b)=> b.date.localeCompare(a.date)).slice(0,5).map(t=>`${formatDDMMYYYY(t.date)} ‚Äî ${t.desc} ‚Äî ${$('#setting-currency').value||'‚Ç±'}${currencyFmt(t.amt)}`).join('<br>')||'<span class="small">No transactions</span>');
      scheduleChartsUpdate();
    }

    // Transactions table & helpers (from doc)
    function renderTransactionsTable(filterText=''){
      const tbody = document.querySelector('#tx-table tbody'); if(!tbody) return;
      tbody.innerHTML = '';
      const list = state.transactions.slice().sort((a,b)=> b.date.localeCompare(a.date));
      const filtered = filterText ? list.filter(t => JSON.stringify(t).toLowerCase().includes(filterText.toLowerCase())) : list;
      filtered.forEach(tx=>{
        const balAfter = computeBalanceAfter(tx);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="px-2 py-1">${formatDDMMYYYY(tx.date)}</td><td class="px-2 py-1">${tx.desc||''}</td><td class="px-2 py-1">${tx.cat||''}</td><td class="px-2 py-1">${$('#setting-currency').value||'‚Ç±'}${currencyFmt(tx.amt)}</td><td class="px-2 py-1">${$('#setting-currency').value||'‚Ç±'}${currencyFmt(balAfter)}</td><td class="px-2 py-1">${tx.linked||''}</td><td class="px-2 py-1">${tx.notes||''}</td><td class="px-2 py-1">${(tx.tags||[]).join(', ')}</td><td class="px-2 py-1">${tx.status||''}</td><td class="px-2 py-1"><button data-del-tx="${tx.id}" class="text-red-600 small">Delete</button></td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('[data-del-tx]').forEach(btn=>btn.onclick = ()=>{ deleteTransaction(btn.dataset.delTx); });
    }
    function computeBalanceAfter(tx){
      const sorted = state.transactions.slice().sort((a,b)=> a.date.localeCompare(b.date));
      let bal=0;
      for(const t of sorted){ bal += Number(t.amt||0); if(t.id === tx.id) break; }
      return bal;
    }

    // Budgets & savings renders
    function renderBudgets(){ const cont=$('#budget-rows'); if(!cont) return; cont.innerHTML=''; state.budgets.forEach(b=>{ const spent = state.transactions.filter(t=>t.cat===b.cat && t.type==='expense').reduce((s,x)=>s+Number(x.amt||0),0); const pct = b.limit ? Math.min(100, Math.round(100*spent/b.limit)) : 0; const el=document.createElement('div'); el.className='p-2 border rounded mb-2'; el.innerHTML = `<div class="flex justify-between"><div>${b.cat}</div><div>${$('#setting-currency').value||'‚Ç±'}${currencyFmt(spent)} / ${$('#setting-currency').value||'‚Ç±'}${currencyFmt(b.limit)}</div></div><div class="w-full bg-gray-100 h-2 rounded mt-2"><div style="width:${pct}%;height:100%;background:linear-gradient(90deg,var(--pink),var(--pink-deep))"></div></div>`; cont.appendChild(el); }); }
    function renderSavings(){ const cont=$('#savings-list'); if(!cont) return; cont.innerHTML=''; state.savings.forEach(s=>{ const pct = s.target ? Math.min(100, Math.round(100*Number(s.current||0)/Number(s.target||1))) : 0; const el=document.createElement('div'); el.className='p-2 border rounded mb-2'; el.innerHTML = `<div class="flex justify-between"><div>${s.name}</div><div>${$('#setting-currency').value||'‚Ç±'}${currencyFmt(s.current)} / ${$('#setting-currency').value||'‚Ç±'}${currencyFmt(s.target)}</div></div><div class="w-full bg-gray-100 h-2 rounded mt-2"><div style="width:${pct}%;height:100%;background:linear-gradient(90deg,#60a5fa,#7c3aed)"></div></div>`; cont.appendChild(el); }); }

    // Jobs & bills quick lists
    function renderJobsQuick(){ const c=$('#jobs-quick'); if(!c) return; c.innerHTML=''; state.jobs.forEach(j=>{ const el=document.createElement('div'); el.className='p-2 border rounded mb-2'; el.innerHTML=`<div class="font-semibold">${j.company} ‚Äî ${j.role}</div><div class="small">‚Ç±${currencyFmt(j.salary)} ‚Äî ${j.payCycle}</div>`; c.appendChild(el); }); }
    function renderBillsList(){ const c=$('#bills-quick'); if(!c) return; c.innerHTML=''; state.bills.forEach(b=>{ const el=document.createElement('div'); el.className='p-2 border rounded mb-2'; el.innerHTML = `<div class="font-semibold">${b.name}</div><div class="small">Day ${b.day} ‚Ä¢ ‚Ç±${currencyFmt(b.amount)} ‚Ä¢ ${b.auto? 'Auto' : 'Manual'}</div>`; c.appendChild(el); }); }

    // Calendar (from doc)
    let calendarDate = new Date(new Date().toLocaleString('en-PH',{timeZone:TZ}));
    function renderCalendar(){
      const grid = $('#calendar-grid'); if(!grid) return; grid.innerHTML='';
      const year = calendarDate.getFullYear(), month = calendarDate.getMonth();
      $('#calendar-month-label').textContent = calendarDate.toLocaleString('en-PH',{month:'long', year:'numeric'});
      const firstWeekday = new Date(year, month, 1).getDay();
      for(let i=0;i<firstWeekday;i++) grid.appendChild(document.createElement('div'));
      const days = new Date(year, month+1, 0).getDate();
      for(let d=1; d<=days; d++){
        const iso = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const cell = document.createElement('div'); cell.className='p-2 border rounded bg-white';
        cell.innerHTML = `<div class="font-semibold">${d}</div>`;
        const dayEvents = state.events.filter(e=> e.date === iso);
        dayEvents.forEach(ev => {
          const chip = document.createElement('div'); chip.className='calendar-chip'; chip.textContent = `${ev.emoji} ${ev.title}`; cell.appendChild(chip);
        });
        grid.appendChild(cell);
      }
      // events list
      const evList = $('#calendar-events'); evList.innerHTML = state.events.map(e=>`<div class="hist-row"><div><div class="hist-meta">${e.emoji} ${e.title}</div><div class="muted">${e.date}</div></div><div><button data-edit-event="${e.id}" class="btn-outline small">Edit</button></div></div>`).join('') || '<div class="small muted">No events</div>';
      evList.querySelectorAll('[data-edit-event]').forEach(b=> b.onclick = ()=> openEditEvent(b.dataset.editEvent));
    }

    // Charts (monthly & trends)
    let monthlyChart=null, trendsChart=null, chartTimer=null;
    function scheduleChartsUpdate(){ if(chartTimer) clearTimeout(chartTimer); chartTimer = setTimeout(()=>{ renderMonthlyChart($('#dashboard-range')?.value || 'monthly'); renderTrendsChart($('#reports-range')?.value || 'monthly'); }, DEBOUNCE_MS); }
    function renderMonthlyChart(range='monthly'){
      try{
        const ctx = document.getElementById('chart-monthly').getContext('2d');
        const now = new Date(new Date().toLocaleString('en-PH',{timeZone:TZ}));
        const labels=[], inc=[], exp=[];
        for(let i=5;i>=0;i--){ const d=new Date(now.getFullYear(), now.getMonth()-i,1); labels.push(d.toLocaleString('en-PH',{month:'short', year:'numeric'})); const ym=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; inc.push(state.transactions.filter(t=>t.type==='income' && t.date.startsWith(ym)).reduce((s,x)=>s+Number(x.amt||0),0)); exp.push(state.transactions.filter(t=>t.type==='expense' && t.date.startsWith(ym)).reduce((s,x)=>s+Number(x.amt||0),0)); }
        if(monthlyChart) monthlyChart.destroy();
        monthlyChart = new Chart(ctx,{ type:'bar', data:{ labels, datasets:[ { label:'Income', data:inc }, { label:'Expenses', data:exp } ] }, options:{ responsive:true, maintainAspectRatio:false } });
      }catch(e){}
    }
    function renderTrendsChart(range='monthly'){
      try{
        const ctx = document.getElementById('chart-trends').getContext('2d'); const now = new Date(new Date().toLocaleString('en-PH',{timeZone:TZ})); const labels=[], inc=[], exp=[];
        for(let i=5;i>=0;i--){ const d=new Date(now.getFullYear(), now.getMonth()-i,1); labels.push(d.toLocaleString('en-PH',{month:'short', year:'numeric'})); const ym=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; inc.push(state.transactions.filter(t=>t.type==='income' && t.date.startsWith(ym)).reduce((s,x)=>s+Number(x.amt||0),0)); exp.push(state.transactions.filter(t=>t.type==='expense' && t.date.startsWith(ym)).reduce((s,x)=>s+Number(x.amt||0),0)); }
        if(trendsChart) trendsChart.destroy();
        trendsChart = new Chart(ctx,{ type:'line', data:{ labels, datasets:[ {label:'Income', data:inc, borderColor:'#34d399', fill:false}, {label:'Expenses', data:exp, borderColor:'#f87171', fill:false} ] }, options:{ responsive:true, animation:{duration:500}, plugins:{ legend:{position:'bottom'} } } });
      }catch(e){}
    }

    // Pay period logic (biweekly cutoffs) ‚Äî from doc
    function getLastDayOfMonth(y,m){ return new Date(y, m+1, 0).getDate(); }
    function manilaNowDate(){ return new Date(new Date().toLocaleString('en-PH',{timeZone:TZ})); }
    function computePayPeriodDatesForRange(range, refDate=null){
      const manNow = refDate ? new Date(refDate) : manilaNowDate();
      const y = manNow.getFullYear(), m = manNow.getMonth(), d = manNow.getDate();
      let start, end, payday;
      if(range === 'biweekly'){
        if(d <= 15){ start = new Date(y, m, 1); end = new Date(y, m, 15); payday = new Date(y, m+1, 0); }
        else { start = new Date(y, m, 16); end = new Date(y, m+1, 0); const nextMonth = new Date(y, m+1, 1); payday = new Date(nextMonth.getFullYear(), nextMonth.getMonth(), 15); }
      } else if(range === 'weekly'){
        const dayOfWeek = (manNow.getDay() + 6) % 7; start = new Date(manNow); start.setDate(manNow.getDate() - dayOfWeek);
        end = new Date(start); end.setDate(start.getDate() + 6); payday = new Date(end);
      } else {
        start = new Date(y, m, 1); end = new Date(y, m+1, 0); payday = new Date(y, m+1, 0);
      }
      return { startISO: start.toISOString().slice(0,10), endISO: end.toISOString().slice(0,10), paydayISO: payday.toISOString().slice(0,10), start, end, payday };
    }

    // Notifications + chime (from doc)
    function playChimeIfAllowed(){
      try{ if(localStorage.getItem('lexi_mute')==='true') return; const a=document.getElementById('kitten-chime'); a.currentTime=0; a.play().catch(()=>{}); if(bc) bc.postMessage({type:'play-chime'}); }catch(e){}
    }
    function notifyIfAllowed(text){
      try{
        if('Notification' in window){
          if(Notification.permission==='granted'){ new Notification('Lexi üêæ',{body:text}); }
          else if(Notification.permission==='default'){ Notification.requestPermission().then(p=>{ if(p==='granted') new Notification('Lexi üêæ',{body:text}); }); }
        }
      }catch(e){}
    }

    // Events emoji mapping (from doc)
    function emojiForTitle(title=''){ const t=(title||'').toLowerCase(); if(/bill|due|payment/.test(t)) return 'üí∏'; if(/salary|payday|payout/.test(t)) return 'üí∞'; if(/birthday/.test(t)) return 'üéÇ'; if(/meeting|interview/.test(t)) return 'üìÖ'; if(/doctor|clinic/.test(t)) return 'üè•'; if(/flight|travel/.test(t)) return '‚úàÔ∏è'; if(/anniversary/.test(t)) return 'üíñ'; return 'üêæ'; }

    // Due badge / check for upcoming items (from doc)
    function computeUpcomingPaydaysWithin(days=2){
      const now = manilaNowDate(); const list=[];
      state.jobs.forEach(job=>{
        const pp = computePayPeriodDatesForRange(job.payCycle || 'monthly', now);
        const payday = new Date(pp.paydayISO);
        const diff = Math.round((payday - manilaNowDate()) / (1000*60*60*24));
        if(Math.abs(diff) <= days) list.push({job, paydayISO: pp.paydayISO});
      });
      return list;
    }
    function checkDueBadge(){
      const today = new Date().toLocaleString('sv-SE',{timeZone:TZ}).split(' ')[0];
      const todayDay = Number(today.split('-')[2]);
      const nearBills = state.bills.filter(b=> Math.abs(Number(b.day)-todayDay) <= 2 );
      const todayEvents = state.events.filter(e=>e.date === today);
      const upcomingPay = computeUpcomingPaydaysWithin(2);
      const total = nearBills.length + todayEvents.length + upcomingPay.length;
      const badge = $('#due-badge');
      if(total>0){ badge.textContent = `üîî Due Today! (${total})`; badge.classList.remove('hidden'); badge.classList.add('blink'); badge.onclick = ()=> document.querySelector('.tab-btn[data-tab="calendar"]').click(); playChimeIfAllowed(); notifyIfAllowed(`You have ${total} due items or paydays within 2 days. üêæ`); }
      else { badge.classList.add('hidden'); badge.classList.remove('blink'); badge.onclick = null; }
    }

    // Bills auto-generate (from doc)
    function addBill(b){ state.bills.push(b); if(b.auto){ const isoMonth = new Date().toISOString().slice(0,7); const day = String(Number(b.day)).padStart(2,'0'); const txDate = `${isoMonth}-${day}`; const exists = state.transactions.some(t=>t.desc===b.name && t.date===txDate && Number(t.amt)===Number(b.amount)); if(!exists) state.transactions.push({ id:crypto.randomUUID(), date:txDate, desc:b.name, cat:'Bills', amt:Number(b.amount||0), type:'expense', notes:'Auto-generated', tags:[], status:'planned', linked:b.id }); } saveAll(); }

    // Save state (debounced-ish) with undo push + broadcast (from doc)
    async function saveAll(){ pushUndo(); await idbPut('state', state); broadcastState(); scheduleChartsUpdate(); checkDueBadge(); toast('Saved'); }

    // CRUD flows (transactions, jobs, events)
    // Transaction modal open/new
    let editingTxId = null;
    $('#add-tx-btn')?.addEventListener('click', ()=>{ editingTxId=null; $('#tx-form-date').value = todayISO(); $('#tx-form-desc').value=''; $('#tx-form-cat').value=''; $('#tx-form-amt').value=''; $('#tx-form-notes').value=''; $('#tx-form-tags').value=''; $('#tx-form-status').value='planned'; $('#tx-delete-btn').classList.add('hidden'); openModal('modal-transaction'); });
    $('#tx-cancel-btn')?.addEventListener('click', ()=> closeModal('modal-transaction'));
    $('#tx-save-btn')?.addEventListener('click', ()=> {
      const tx={ id:editingTxId||crypto.randomUUID(), date:$('#tx-form-date').value||todayISO(), desc:$('#tx-form-desc').value||'', cat:$('#tx-form-cat').value||'Misc', amt:Number($('#tx-form-amt').value)||0, type:(Number($('#tx-form-amt').value)>=0)?'income':'expense', notes:$('#tx-form-notes').value||'', tags:($('#tx-form-tags').value||'').split(',').map(s=>s.trim()).filter(Boolean), status:$('#tx-form-status').value||'planned', linked:'' };
      if(editingTxId){ const i=state.transactions.findIndex(t=>t.id===editingTxId); if(i>-1) state.transactions[i]=tx; } else state.transactions.push(tx);
      saveAll(); closeModal('modal-transaction'); renderTransactionsTable(); renderDashboard();
    });
    $('#tx-delete-btn')?.addEventListener('click', ()=> { if(!editingTxId) return; if(!confirm('Delete transaction?')) return; state.transactions = state.transactions.filter(t=>t.id!==editingTxId); saveAll(); closeModal('modal-transaction'); renderTransactionsTable(); renderDashboard(); });

    // Jobs modal
    let editingJobId = null;
    $('#add-job-btn')?.addEventListener('click', ()=> { editingJobId=null; $('#job-form-company').value=''; $('#job-form-role').value=''; $('#job-form-salary').value=''; $('#job-form-paycycle').value='monthly'; $('#job-delete-btn').classList.add('hidden'); openModal('modal-job'); });
    $('#job-cancel-btn')?.addEventListener('click', ()=> closeModal('modal-job'));
    $('#job-save-btn')?.addEventListener('click', ()=> {
      const j = { id: editingJobId || crypto.randomUUID(), company: $('#job-form-company').value||'Company', role: $('#job-form-role').value||'Role', salary: Number($('#job-form-salary').value)||0, payCycle: $('#job-form-paycycle').value || 'monthly', fulltime: true, workdays: [] };
      if(editingJobId){ const idx = state.jobs.findIndex(x=>x.id===editingJobId); if(idx>-1) state.jobs[idx]=j; } else state.jobs.push(j);
      saveAll(); closeModal('modal-job'); renderJobsQuick(); renderSalaryUI();
    });

    // Event modal
    let editingEventId = null;
    $('#event-save-btn')?.addEventListener('click', ()=> {
      const title = $('#event-form-title').value||'Event'; const notes = $('#event-form-notes').value||''; const date = $('#event-form-date').value||todayISO(); if(editingEventId){ const idx = state.events.findIndex(e=>e.id===editingEventId); if(idx>-1){ state.events[idx].title=title; state.events[idx].notes=notes; state.events[idx].date=date; state.events[idx].emoji = emojiForTitle(title); } } else { const ev = { id:crypto.randomUUID(), title, notes, date, emoji: emojiForTitle(title) }; state.events.push(ev); scheduleNotificationForEvent(ev); } editingEventId=null; closeModal('modal-event'); saveAll(); renderCalendar(); });
    $('#event-cancel-btn')?.addEventListener('click', ()=>{ editingEventId=null; closeModal('modal-event'); });
    $('#event-delete-btn')?.addEventListener('click', ()=>{ if(!editingEventId) return; if(!confirm('Delete event?')) return; state.events = state.events.filter(e=>e.id!==editingEventId); saveAll(); editingEventId=null; closeModal('modal-event'); renderCalendar(); });

    function openEditEvent(id){ const ev = state.events.find(e=>e.id===id); if(!ev) return; editingEventId = id; $('#event-form-title').value = ev.title; $('#event-form-notes').value = ev.notes; $('#event-form-date').value = ev.date; $('#event-delete-btn').classList.remove('hidden'); openModal('modal-event'); }

    // schedule notifications for event at Manila 9:00 (from doc)
    function scheduleNotificationForEvent(ev){
      try{
        const manila9 = new Date(new Date(ev.date + 'T09:00:00').toLocaleString('en-US',{timeZone:TZ}));
        const ms = manila9.getTime() - Date.now();
        if(ms>0 && ms < 1000*60*60*24*365) setTimeout(()=> { notifyIfAllowed(`${ev.emoji} ${ev.title} ‚Äî ${ev.notes||''}`); playChimeIfAllowed(); }, ms);
      }catch(e){}
    }

    // Backup / Restore AES-GCM (from doc)
    async function deriveKey(password, salt){ const enc = new TextEncoder().encode(password); const base = await crypto.subtle.importKey('raw', enc, 'PBKDF2', false, ['deriveKey']); return crypto.subtle.deriveKey({ name:'PBKDF2', salt, iterations:100000, hash:'SHA-256' }, base, { name:'AES-GCM', length:256 }, false, ['encrypt','decrypt']); }
    $('#backup-btn')?.addEventListener('click', async ()=> {
      const pwd = prompt('Enter password to encrypt backup:'); if(!pwd) return;
      const salt = crypto.getRandomValues(new Uint8Array(16)); const key = await deriveKey(pwd, salt); const iv = crypto.getRandomValues(new Uint8Array(12));
      const enc = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, new TextEncoder().encode(JSON.stringify(state)));
      const container = new Uint8Array(16 + 12 + enc.byteLength); container.set(salt,0); container.set(iv,16); container.set(new Uint8Array(enc),28);
      const blob = new Blob([container], { type:'application/octet-stream' }); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='lexi_backup.lexi'; a.click(); URL.revokeObjectURL(url);
    });
    $('#restore-btn')?.addEventListener('click', ()=> {
      const fi=document.createElement('input'); fi.type='file'; fi.accept='.lexi'; fi.onchange=async e=>{ const f=e.target.files[0]; if(!f) return; const pwd=prompt('Password to decrypt backup:'); if(!pwd) return; const arr=new Uint8Array(await f.arrayBuffer()); const salt=arr.slice(0,16); const iv=arr.slice(16,28); const data=arr.slice(28); const key = await deriveKey(pwd, salt); try{ const dec = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, data); const txt = new TextDecoder().decode(dec); state = JSON.parse(txt); await idbPut('state', state); applyStateToUI(); alert('Restore OK'); }catch(err){ alert('Restore failed: invalid password or corrupted file'); } }; fi.click();
    });

    // Simple modal open/close helpers (from doc)
    function openModal(id){ const el = document.getElementById(id); if(!el) return; el.classList.add('open'); el.style.display='flex'; el.classList.remove('hidden'); }
    function closeModal(id){ const el = document.getElementById(id); if(!el) return; el.classList.remove('open'); el.style.display='none'; el.classList.add('hidden'); }

    // Delete transaction helper
    function deleteTransaction(id){ if(!confirm('Delete this transaction?')) return; state.transactions = state.transactions.filter(t=>t.id!==id); saveAll(); renderTransactionsTable(); renderDashboard(); }

    // UI: small helpers: clock, quotes, paw spawn, weather & holiday
    function updateClock(){ const nowStr = new Date().toLocaleString('en-PH', { timeZone: TZ, weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true }); $('#manila-clock').textContent = nowStr; }
    setInterval(updateClock, 1000); updateClock();
    const quotes = ["Keep going, Lexi! üêæ","Small savings, big dreams ‚ú®","Every peso counts üíñ","Budgeting = Freedom üí∞","You're doing great! üå∏"];
    let qi=0; function rotateQuote(){ $('#motivational-quote') && ($('#motivational-quote').textContent = quotes[qi]); qi=(qi+1)%quotes.length; } setInterval(rotateQuote, 10000); rotateQuote();
    function spawnPaw(){ const d=document.createElement('div'); d.className='floating-paw'; d.textContent='üêæ'; const left=Math.random()*100; const top=92+Math.random()*26; d.style.left=`${left}vw`; d.style.top=`${top}vh`; d.style.transition='transform 12s linear, opacity 12s linear'; document.body.appendChild(d); requestAnimationFrame(()=> d.style.transform=`translateY(-140vh) rotate(${Math.random()*180-90}deg)`, d.style.opacity='0'); setTimeout(()=> d.remove(),12000); } setInterval(spawnPaw, 3200);

    // Weather & PH holidays (Open-Meteo & Nager.Date) - from doc
    async function fetchDavaoWeatherAndHoliday(){
      try{ const w = await fetch('https://api.open-meteo.com/v1/forecast?latitude=7.1907&longitude=125.4553&current_weather=true&timezone=Asia%2FManila'); const jw = await w.json(); if(jw?.current_weather){ const cw = jw.current_weather; $('#davao-weather').textContent = `Davao: ${cw.temperature}¬∞C ‚Ä¢ ${cw.windspeed} km/h`; } else $('#davao-weather').textContent='Weather: unavailable'; }catch(e){ $('#davao-weather').textContent='Weather: offline'; }
      try{ const yr = new Date().getFullYear(); const res = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${yr}/PH`); const list = await res.json(); const today = todayISO(); const h = (list||[]).find(x => x.date === today); if(h) $('#phil-holiday').textContent = `Holiday: ${h.localName}`; else $('#phil-holiday').textContent = ''; }catch(e){ $('#phil-holiday').textContent = ''; }
    }
    fetchDavaoWeatherAndHoliday(); setInterval(fetchDavaoWeatherAndHoliday, 1000 * 60 * 30);

    // Chart initial schedule
    scheduleChartsUpdate();

    // SW register (from doc)
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('/lexi-sw.js').then(reg => {
        reg.addEventListener('updatefound', ()=>{ const newSW = reg.installing; newSW.addEventListener('statechange', ()=>{ if(newSW.state==='installed'){ if(bc) bc.postMessage({type:'sw-update'}); else showUpdateBanner(); } }); });
      }).catch(()=>console.warn('SW register failed'));
      navigator.serviceWorker.addEventListener && navigator.serviceWorker.addEventListener('message', (ev)=>{ if(ev.data==='reload'){ showUpdateBanner(); } if(ev.data?.type === 'background-sync'){ if(typeof window.handleBackgroundSync === 'function') window.handleBackgroundSync(); } if(ev.data?.type === 'play-chime'){ playChimeIfAllowed(); }});
    }

    // Update banner
    function showUpdateBanner(){ const b = document.createElement('div'); b.style.position='fixed'; b.style.bottom='16px'; b.style.left='50%'; b.style.transform='translateX(-50%)'; b.style.background='linear-gradient(90deg,#fff1f6,#ffe6f2)'; b.style.color='#7b1b4b'; b.style.padding='8px 12px'; b.style.borderRadius='12px'; b.style.boxShadow='0 6px 20px rgba(0,0,0,0.08)'; b.style.zIndex=9999; b.textContent = 'Lexi updated ‚ú® refreshing...'; document.body.appendChild(b); setTimeout(()=>{ try{ location.reload(); }catch(e){} }, 900); }

    // Keyboard shortcuts for undo/redo (from doc)
    window.addEventListener('keydown', e=>{ const cmd = e.ctrlKey || e.metaKey; if(cmd && e.key==='z' && !e.shiftKey){ e.preventDefault(); undo(); } if(cmd && (e.key==='Z' || (e.shiftKey && e.key==='Z'))){ e.preventDefault(); redo(); } });

    // Tabs wiring (preserve IDs)
    $$('.tab-btn').forEach(btn=>btn.addEventListener('click', ()=>{ const tab=btn.dataset.tab; $$('.tab-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); $$('main section').forEach(s=>s.classList.add('hidden')); const panel = document.getElementById('panel-'+tab); if(panel) panel.classList.remove('hidden'); if(tab==='dashboard') renderDashboard(); if(tab==='calendar') renderCalendar(); if(tab==='transactions') renderTransactionsTable(); if(tab==='salary') renderSalaryUI(); }));
    document.addEventListener('DOMContentLoaded', ()=>{ document.querySelector('.tab-btn.active')?.click(); });

    // Filter wiring
    $('#tx-filter')?.addEventListener('input', (e)=> renderTransactionsTable(e.target.value));

    // Sound toggle
    $('#sound-toggle')?.addEventListener('click', ()=>{ const m = localStorage.getItem('lexi_mute') === 'true'; localStorage.setItem('lexi_mute', (!m).toString()); toast(m ? 'Sound unmuted' : 'Sound muted'); });

    // Export/import JSON
    $('#export-json')?.addEventListener('click', ()=>{ const b=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='lexi_export.json'; a.click(); URL.revokeObjectURL(u); });
    $('#import-json')?.addEventListener('click', ()=>{ const fi=document.createElement('input'); fi.type='file'; fi.accept='application/json'; fi.onchange=async e=>{ const t = await e.target.files[0].text(); try{ state = JSON.parse(t); await idbPut('state', state); applyStateToUI(); toast('Import OK'); }catch(err){ alert('Invalid JSON'); } }; fi.click(); });

    // Seed & boot (from doc)
    async function seedIfEmpty(){ const s = await idbGet('state'); if(s){ state=s; return; } const iso = todayISO(); state.jobs.push({ id:crypto.randomUUID(), company:'Acme Co', role:'VA', salary:30000, payCycle:'monthly', fulltime:true, workdays:[] }); state.transactions.push({ id:crypto.randomUUID(), date:iso, desc:'Seed Salary', cat:'Job', amt:30000, type:'income', notes:'Seed', tags:['paycheck'], status:'actual', linked:'' }); state.transactions.push({ id:crypto.randomUUID(), date:iso, desc:'Groceries', cat:'Food', amt:1200, type:'expense', notes:'Seed', tags:[], status:'actual', linked:'' }); state.bills.push({ id:crypto.randomUUID(), name:'Internet', day:5, amount:1500, auto:true, paid:false }); state.savings.push({ id:crypto.randomUUID(), name:'Rainy Day', current:2000, target:10000 }); await idbPut('state', state); }

    async function boot(){
      try{ await openDB(); }catch(e){ console.warn('IndexedDB error', e); }
      await seedIfEmpty();
      const saved = await idbGet('state'); if(saved) state = saved;
      applyStateToUI();
      setInterval(()=> idbPut('state', state), 5000);
      if('Notification' in window && Notification.permission === 'default') try{ await Notification.requestPermission(); }catch(e){}
    }

    boot();

    // Expose some helpers for debugging (from doc)
    window.lexi = { state, saveAll, undo, redo };

    // Expose a handler to run when SW asks for background sync (optional)
    window.handleBackgroundSync = async function(){ toast('Background sync triggered'); /* implement server sync here if you want */ };

  })();
  </script>
</body>
</html>
