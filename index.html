<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lexi ‚Äî Pastel Pink Kitten Budget Tracker</title>

  <!-- Tailwind -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <meta name="theme-color" content="#ffd6ea" />
  <style>
    /* ========== Shared theme ========== */
    :root{
      --pink-50:#fff1f6;
      --pink-100:#ffe6f2;
      --pink-200:#ffd6ea;
      --pink-300:#ffb6d9;
      --pink-400:#ff95c6;
      --ink:#6b1233;
      --card:#fff7fb;
    }
    body{ background: linear-gradient(180deg,var(--pink-50),#fff 40%); color:var(--ink); font-family:Inter,system-ui,Segoe UI,Arial; -webkit-font-smoothing:antialiased; }
    header{ background: linear-gradient(90deg,var(--pink-100),var(--pink-200)); border-bottom: 1px solid rgba(255,182,217,.3); }
    .card{ background:var(--card); border:1px solid rgba(255,182,217,.35); border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(255,149,198,.08); }
    .btn{ background: linear-gradient(90deg,var(--pink-300),var(--pink-400)); color:white; padding:.5rem .9rem; border-radius:.6rem; font-weight:600; box-shadow: 0 8px 20px rgba(255,149,198,.18); border:0; }
    .btn-outline{ border:1px solid var(--pink-300); color:var(--ink); padding:.45rem .8rem; border-radius:.6rem; background:white; }
    .tab-btn{ padding:.45rem .8rem; border-radius:999px; background:transparent; border:1px solid transparent; color:var(--ink); }
    .tab-btn[aria-selected="true"]{ background:linear-gradient(90deg,var(--pink-300),var(--pink-200)); color:white; box-shadow:0 6px 16px rgba(255,149,198,.12); }
    .small{ font-size:.85rem; color:#5a2a44; }
    .chip{ display:inline-block; padding:.15rem .5rem; border-radius:999px; font-size:.78rem; }
    .chip-pay{ background:linear-gradient(90deg,#e6fff5,#e6fff0); color:#086533; border:1px solid rgba(10,100,60,.06); }
    .chip-bill{ background:linear-gradient(90deg,#fff0f2,#fff6f9); color:#6b1233; border:1px solid rgba(107,18,51,.06); }
    .calendar-day{ min-height:88px; border-radius:.6rem; padding:8px; background:white; border:1px dashed rgba(255,182,217,.18); }
    .kitten-surprise{ position:fixed; right:18px; bottom:18px; z-index:9999; pointer-events:none; transform-origin: center; }
    .toast{ position:fixed; right:18px; top:18px; z-index:9999; min-width:260px; max-width:360px; border-radius:12px; padding:12px; box-shadow:0 12px 36px rgba(0,0,0,.12); display:flex; gap:10px; align-items:flex-start; }
    /* Per-tab playful accents */
    .tab-dashboard .card { transition:transform .18s ease; }
    .tab-transactions button:hover { transform:translateY(-3px); }
    .tab-salary .pay-pill { border-radius:12px; padding:6px 8px; display:inline-block; background:linear-gradient(90deg,#fff0f6,#ffe6f2); color:var(--ink); }
    .tab-calendar .calendar-day:hover { transform: translateY(-4px); transition: transform .15s ease; box-shadow:0 8px 24px rgba(255,149,198,.06); }
    .tab-settings .card { border-style:dashed; border-width:1px; }
    .visually-hidden{ position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; }
    /* Make keyboard focus obvious */
    :focus{ outline: 3px solid rgba(255,149,198,.28); outline-offset: 2px; border-radius:8px; }
  </style>
</head>
<body class="min-h-screen">
  <header class="p-4">
    <div class="max-w-6xl mx-auto flex flex-col md:flex-row items-start md:items-center justify-between gap-2">
      <div class="flex items-center gap-3">
        <div class="text-2xl font-extrabold" aria-hidden>Lexi üê±</div>
        <div class="small">Pastel Pink Kitten Budget Tracker</div>
      </div>

      <div class="flex items-center gap-4">
        <div class="small">Philippine time</div>
        <div id="manila-clock" aria-live="polite" class="font-mono text-sm"></div>
        <div>
          <button id="notif-toggle" class="btn-outline" type="button" aria-pressed="false">Enable reminders</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <nav class="max-w-6xl mx-auto mt-4 px-4" role="tablist" aria-label="Primary">
    <div class="flex gap-2">
      <button class="tab-btn" role="tab" aria-selected="true" data-tab="dashboard" id="tab-dashboard">Dashboard</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="transactions" id="tab-transactions">Transactions</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="salary" id="tab-salary">Salary</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="calendar" id="tab-calendar">Calendar</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="settings" id="tab-settings">Settings</button>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto p-4 grid gap-6" id="app" role="main">
    <!-- Dashboard (unique, playful) -->
    <section id="panel-dashboard" class="tab-dashboard" role="tabpanel" aria-labelledby="tab-dashboard">
      <div class="grid md:grid-cols-3 gap-4">
        <div class="card" aria-labelledby="quick-stats">
          <h2 id="quick-stats" class="font-semibold">Quick Stats <span class="small">‚Ä¢ cute & helpful</span></h2>
          <div class="mt-3 small"><strong>Active job:</strong> <span id="active-job-info">‚Äî</span></div>
          <div class="mt-1 small"><strong>Upcoming payday(s):</strong> <div id="dashboard-paydays" class="mt-1"></div></div>
          <div class="mt-1 small"><strong>Upcoming bills:</strong> <div id="dashboard-bills" class="mt-1"></div></div>
          <div class="mt-3">
            <button id="surprise-btn" class="btn" type="button">Kitten surprise üéÅ</button>
          </div>
        </div>

        <div class="card" aria-labelledby="recent">
          <h3 id="recent" class="font-semibold">Recent Activity</h3>
          <div id="panel-recent" class="mt-3 small"></div>
        </div>

        <div class="card" aria-labelledby="insights">
          <h3 id="insights" class="font-semibold">Insights</h3>
          <div class="small mt-2">Simple charts to show trends</div>
          <canvas id="chart-dash" height="120" class="mt-3" aria-hidden="true"></canvas>
        </div>

        <div class="card md:col-span-3">
          <h3 class="font-semibold">Notifications & Reminders</h3>
          <div class="small mt-2">Live reminders will appear here when due:</div>
          <div id="live-reminders" class="mt-2"></div>
        </div>
      </div>
    </section>

    <!-- Transactions -->
    <section id="panel-transactions" class="hidden tab-transactions" role="tabpanel" aria-labelledby="tab-transactions">
      <div class="card">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Transactions</h3>
          <div class="flex items-center gap-2">
            <input id="tx-search" class="border rounded px-2 py-1 small" placeholder="Search transactions..." aria-label="Search transactions">
            <button id="add-tx" class="btn" type="button">Add</button>
            <button id="export" class="btn-outline" type="button">Export</button>
          </div>
        </div>

        <div class="mt-3 overflow-x-auto">
          <table class="w-full mt-2" id="tx-table" aria-describedby="transactions">
            <thead class="small text-left text-sm">
              <tr>
                <th>Date</th><th>Description</th><th>Category</th><th class="text-right">Amount</th><th>Status</th><th></th>
              </tr>
            </thead>
            <tbody class="align-top"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Salary -->
    <section id="panel-salary" class="hidden tab-salary" role="tabpanel" aria-labelledby="tab-salary">
      <div class="grid md:grid-cols-2 gap-4">
        <div class="card" aria-labelledby="jobs">
          <h3 id="jobs" class="font-semibold">Jobs & Paycycles</h3>
          <div id="jobs-list" class="mt-3 small"></div>
          <div class="mt-3">
            <button id="add-job" class="btn" type="button">Add Job</button>
          </div>
        </div>

        <div class="card" aria-labelledby="paystub">
          <h3 id="paystub" class="font-semibold">Paystub / Compute</h3>
          <div class="mt-2 small" id="paystub-preview">No paystub computed yet.</div>
          <div class="mt-3 flex gap-2">
            <button id="compute-paycheck" class="btn" type="button">Compute</button>
            <button id="sync-paycheck" class="btn-outline" type="button">Sync (planned)</button>
          </div>
        </div>

        <div class="card md:col-span-2">
          <h3 class="font-semibold">Workday Records</h3>
          <div class="mt-2 small">
            <label>Job <select id="wd-job"></select></label>
            <label class="ml-2">Date <input id="wd-date" type="date"></label>
            <label class="ml-2">Hours <input id="wd-hours" type="number" step="0.25" min="0" style="width:80px"></label>
            <label class="ml-2">OT <input id="wd-ot" type="number" step="0.25" min="0" style="width:80px"></label>
            <label class="ml-2">Ded <input id="wd-ded" type="number" step="0.01" min="0" style="width:80px"></label>
            <button id="wd-add" class="btn-outline ml-2" type="button">Add</button>
          </div>
          <div id="wd-list" class="mt-3"></div>
        </div>
      </div>
    </section>

    <!-- Calendar -->
    <section id="panel-calendar" class="hidden tab-calendar" role="tabpanel" aria-labelledby="tab-calendar">
      <div class="card">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Calendar</h3>
          <div class="small">
            <button id="cal-prev" class="btn-outline" type="button">‚óÄ</button>
            <span id="cal-label" class="mx-2"></span>
            <button id="cal-next" class="btn-outline" type="button">‚ñ∂</button>
            <button id="add-event" class="btn ml-3" type="button">+ Event</button>
          </div>
        </div>

        <div class="grid grid-cols-7 gap-2 mt-3" id="calendar-grid" role="grid" aria-label="Calendar"></div>
      </div>
    </section>

    <!-- Settings -->
    <section id="panel-settings" class="hidden tab-settings" role="tabpanel" aria-labelledby="tab-settings">
      <div class="grid md:grid-cols-2 gap-4">
        <div class="card">
          <h3 class="font-semibold">Preferences</h3>
          <div class="mt-3 small">
            <label>Currency <input id="pref-currency" class="border rounded px-2 py-1" value="‚Ç±"></label><br>
            <label>Avg workdays/mo <input id="pref-workdays" type="number" value="22" class="border rounded px-2 py-1"></label><br>
            <label>Reminder lookahead (days) <input id="pref-remind-days" type="number" value="2" class="border rounded px-2 py-1"></label>
          </div>
        </div>

        <div class="card">
          <h3 class="font-semibold">Appearance</h3>
          <div class="mt-3 small">Choose playful accents for each tab</div>
          <div class="mt-2">
            <label><input type="radio" name="accent" value="classic" checked> Classic Kitten</label><br>
            <label><input type="radio" name="accent" value="sparkle"> Sparkles</label><br>
            <label><input type="radio" name="accent" value="neon"> Neon Pop</label>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Toast container (for in-app notifications) -->
  <div id="toasts" aria-live="polite" class="visually-hidden"></div>
  <img id="kitten-surprise" class="kitten-surprise" alt="" style="display:none" />

  <!-- Accessible modals (transactions, jobs, events). Hidden by default -->
  <div id="modal-transaction" class="hidden" role="dialog" aria-modal="true" aria-labelledby="modal-transaction-title">
    <!-- content substituted by JS -->
  </div>

  <script>
  /* ========================== Lexi - Full App ==========================
     Features:
     - Manila local time (12-hr) and live clock
     - Per-tab unique interactions & visuals
     - Paycycle logic: 1‚Äì15 => paid EOM, 16‚ÄìEOM => paid 15th next month
     - Notifications (desktop + in-app toasts) with WebAudio chime
     - Calendar with emoji titles and surprises
     - Robust modals, keyboard support, accessibility
     ==================================================================== */

  (function(){
    const TZ = 'Asia/Manila';
    const DB_KEY = 'lexi_state_v3';
    // UI elements
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const toasts = $('#toasts');
    // small helpers
    const pad=(n)=>String(n).padStart(2,'0');
    function nowPH() { return new Date(new Date().toLocaleString('en-PH',{timeZone:TZ})); }
    function todayISO(){ const d = nowPH(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
    function toISO(d){ // d is Date
      const off = d.getTimezoneOffset(); const n = new Date(d.getTime() - off*60000); return n.toISOString().slice(0,10);
    }
    function fmtFriendly(dt){ // 12-hour local time string (no military)
      const d = (typeof dt === 'string') ? new Date(dt + 'T00:00:00') : dt;
      return d.toLocaleString('en-PH', { timeZone: TZ, hour12: true, hour: 'numeric', minute:'2-digit', month:'short', day:'numeric', year:'numeric' });
    }
    function fmtDateOnly(iso){ if(!iso) return ''; const [y,m,d] = iso.split('-'); return `${pad(d)}/${pad(m)}/${y}`; }
    function currency(v){ try{ return (Number(v)||0).toLocaleString('en-PH',{minimumFractionDigits:2}); }catch(e){ return Number(v||0).toFixed(2); } }

    // tiny WebAudio chime (no external files)
    const audioCtx = typeof AudioContext !== 'undefined' ? new AudioContext() : null;
    function playChime(){
      if (!audioCtx) return;
      const t = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type='sine'; o.frequency.setValueAtTime(750, t);
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.18, t+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t+0.9);
      o.connect(g); g.connect(audioCtx.destination);
      o.start(t); o.stop(t+1);
    }

    // Tiny in-app toast
    function showToast({title='', text='', tone='info', autoClose=6000, icon='üê±'}) {
      const id = 'toast-' + Math.random().toString(36).slice(2,8);
      const div = document.createElement('div');
      div.id = id;
      div.className = 'toast card';
      div.style.background = 'linear-gradient(90deg,#fff,#fff9fb)';
      div.innerHTML = `<div style="font-size:20px">${icon}</div><div style="flex:1"><strong style="display:block">${title}</strong><div class="small">${text}</div></div><div><button class="btn-outline" aria-label="Dismiss">OK</button></div>`;
      document.body.appendChild(div);
      div.querySelector('button')?.addEventListener('click', ()=> div.remove());
      if(autoClose) setTimeout(()=> div.remove(), autoClose);
      // ensure visible for screen readers
      toasts.classList.remove('visually-hidden');
      toasts.appendChild(div);
    }

    // Desktop notifications
    async function ensureNotificationPermission(){
      if(!('Notification' in window)) return false;
      if(Notification.permission === 'granted') return true;
      if(Notification.permission !== 'denied') {
        const p = await Notification.requestPermission();
        return p === 'granted';
      }
      return false;
    }
    // trigger desktop + sound + toast
    async function notify({title, body, tag, icon='üê±', requireInteraction=false}) {
      // in-app toast
      showToast({ title, text: body, icon });
      // play chime
      try { playChime(); } catch(e){}
      // desktop
      if(await ensureNotificationPermission()){
        try{
          const n = new Notification(title, { body, tag, silent: true /* we use our own chime */ });
          if(requireInteraction) n.onclick = ()=> window.focus();
        }catch(e){}
      }
    }

    // ---------- persistence ----------
    let state = { transactions:[], jobs:[], bills:[], events:[], savings:[], budgets:[] };
    function saveState(){ try{ localStorage.setItem(DB_KEY, JSON.stringify(state)); }catch(e){ console.warn('save error', e); } }
    function loadState(){ try{ const s = localStorage.getItem(DB_KEY); if(s) state = JSON.parse(s); }catch(e){ console.warn('load', e); } }

    // ---------- seed ----------
    function seed(){
      if(state.jobs.length) return;
      const today = todayISO();
      state.jobs.push({ id: crypto.randomUUID(), company: 'Vigo MT LLC', role:'Agent', salary:30000, payCycle:'biweekly', workdays: [] });
      state.bills.push({ id: crypto.randomUUID(), name:'Internet', day:5, amount:1500, auto:true });
      state.events.push({ id: crypto.randomUUID(), date: today, title:'Welcome to Lexi!', notes:'Tap the kitten surprise üéÅ', emoji:'üê±' });
      saveState();
    }

    // ---------- pay period logic ----------
    // returns { startISO, endISO, payoutISO }
    function coverageForAnchorISO(anchorISO, payCycle){
      const [y, m, d] = anchorISO.split('-').map(Number);
      if(payCycle === 'monthly'){
        const start = `${y}-${pad(m)}-01`;
        const end = new Date(y, m, 0);
        return { startISO: start, endISO: `${y}-${pad(m)}-${pad(end.getDate())}`, payoutISO: `${y}-${pad(m)}-${pad(end.getDate())}` };
      }
      if(payCycle === 'biweekly' || payCycle === 'semi-monthly'){
        // semi-monthly: 1-15 => payout EOM same month; 16-EOM => payout 15 next month
        if(d <= 15){
          const start = `${y}-${pad(m)}-01`;
          const end = `${y}-${pad(m)}-15`;
          // payout: EOM
          const eom = new Date(y, m, 0); // last day of month
          return { startISO: start, endISO: end, payoutISO: `${y}-${pad(m)}-${pad(eom.getDate())}` };
        } else {
          const start = `${y}-${pad(m)}-16`;
          const eom = new Date(y, m, 0);
          const next = new Date(y, m, 1); next.setMonth(next.getMonth()+1);
          return { startISO: start, endISO: `${y}-${pad(m)}-${pad(eom.getDate())}`, payoutISO: `${next.getFullYear()}-${pad(next.getMonth()+1)}-15` };
        }
      }
      // weekly: find Mon-Sun that contains this date -> payout next Monday
      const js = new Date(anchorISO + 'T00:00:00');
      const weekday = (js.getDay() + 6) % 7; // Mon=0
      const startDt = new Date(js); startDt.setDate(js.getDate() - weekday);
      const endDt = new Date(startDt); endDt.setDate(startDt.getDate() + 6);
      const payoutDt = new Date(endDt); payoutDt.setDate(endDt.getDate() + 1); // next Monday
      return { startISO: toISO(startDt), endISO: toISO(endDt), payoutISO: toISO(payoutDt) };
    }

    // get next payout for job relative to refISO (default today)
    function nextPayInfo(job, refISO = todayISO()){
      let info = coverageForAnchorISO(refISO, job.payCycle || 'monthly');
      if(info.payoutISO >= refISO) return { ...info, jobId: job.id, company: job.company };
      // move to day after end
      const nxt = new Date(info.endISO + 'T00:00:00'); nxt.setDate(nxt.getDate() + 1);
      return coverageForAnchorISO(toISO(nxt), job.payCycle || 'monthly');
    }

    // compute paycheck for date range using stored workdays
    function computePaycheck(job, startISO, endISO){
      const records = (job.workdays||[]).filter(r => r.date >= startISO && r.date <= endISO);
      const avgWorkdays = Number($('#pref-workdays')?.value || 22);
      const denom = avgWorkdays * 8;
      const hourly = denom ? (Number(job.salary||0) / denom) : 0;
      let total = 0;
      const breakdown = [];
      for(const r of records){
        const daily = (hourly * Number(r.hoursWorked || 0)) + (hourly * Number(r.overtimeHours||0) * 1.25 || 0);
        const ded = Number(r.deductions || 0);
        total += (daily - ded);
        breakdown.push({ date: r.date, daily, ded });
      }
      return { expected: total, breakdown, hourly };
    }

    // ---------- reminders detection (bills/paydays/events) ----------
    function computeRemindersWindow(days){
      const start = new Date(nowPH()); start.setHours(0,0,0,0);
      const end = new Date(start); end.setDate(start.getDate() + Number(days||2));
      const startISO = toISO(start);
      const endISO = toISO(end);
      const hits = [];
      // bills due on day-of-month
      for(const b of state.bills || []){
        // generate date in current month and next if needed
        const today = nowPH();
        const cand = new Date(today.getFullYear(), today.getMonth(), b.day);
        const candISO = toISO(cand);
        if(candISO >= startISO && candISO <= endISO){
          hits.push({ type: 'bill', id: b.id, day: b.day, amount: b.amount, dateISO: candISO, title: b.name });
        }
      }
      // paydays
      for(const j of state.jobs || []){
        // check current & next period
        let anchor = startISO;
        for(let i=0;i<4;i++){
          const cov = coverageForAnchorISO(anchor, j.payCycle || 'monthly');
          if(cov.payoutISO >= startISO && cov.payoutISO <= endISO){
            hits.push({ type:'payday', jobId:j.id, company:j.company, payoutISO: cov.payoutISO, startISO: cov.startISO, endISO: cov.endISO });
          }
          // next anchor = day after end
          const next = new Date(cov.endISO + 'T00:00:00'); next.setDate(next.getDate() + 1);
          anchor = toISO(next);
        }
      }
      // events
      for(const ev of state.events || []){
        if(ev.date >= startISO && ev.date <= endISO){
          hits.push({ type:'event', id:ev.id, dateISO: ev.date, title: ev.title, notes: ev.notes, emoji: ev.emoji || guessEmoji(ev.title) });
        }
      }
      // sort
      hits.sort((a,b)=> (a.dateISO || a.payoutISO || '') .localeCompare( (b.dateISO || b.payoutISO || '') ));
      return hits;
    }

    // small emoji guesser
    function guessEmoji(title=''){ const t = (title||'').toLowerCase(); if(t.includes('pay')||t.includes('salary')||t.includes('payout')) return 'üí∞'; if(t.includes('bill')||t.includes('due')) return 'üí∏'; if(t.includes('meet')||t.includes('interview')) return 'üìÖ'; if(t.includes('birthday')) return 'üéÇ'; return 'üêæ'; }

    // check reminders and notify
    let remindersTicker = null;
    async function checkAndNotify(){
      const d = Number($('#pref-remind-days')?.value || 2);
      const hits = computeRemindersWindow(d);
      if(hits.length){
        for(const h of hits){
          if(h.type === 'bill'){
            const title = `Bill due: ${h.title}`;
            const body = `Due ${fmtDateOnly(h.dateISO)} ‚Ä¢ ${$('#pref-currency').value || '‚Ç±'}${currency(h.amount)}`;
            notify({ title, body, tag: 'bill-'+h.id, icon:'üí∏' });
          } else if(h.type === 'payday'){
            const title = `Payday ‚Äî ${h.company}`;
            const body = `Covers ${fmtDateOnly(h.startISO)}‚Äî${fmtDateOnly(h.endISO)} ‚Ä¢ ${fmtDateOnly(h.payoutISO)}`;
            notify({ title, body, tag: 'payday-'+h.jobId, icon: 'üí∞' });
            // kitten surprise animation for paydays
            kittenPop();
          } else if(h.type === 'event'){
            notify({ title: `${h.emoji || ''} ${h.title}`, body: `${h.notes || ''} ‚Ä¢ ${fmtDateOnly(h.dateISO)}`, tag: 'event-'+h.id, icon: h.emoji || 'üìÖ' });
          }
        }
      }
      // update live reminders panel
      const list = computeRemindersWindow(7); // show 7-day summary
      $('#live-reminders').innerHTML = list.map(l=>{
        if(l.type==='bill') return `<div class="chip chip-bill">${guessEmoji(l.title)} ${l.title} ‚Äî ${fmtDateOnly(l.dateISO)}</div>`;
        if(l.type==='payday') return `<div class="chip chip-pay">üí∞ ${l.company} ‚Äî ${fmtDateOnly(l.payoutISO)}</div>`;
        return `<div class="chip">${l.emoji || 'üêæ'} ${l.title} ‚Äî ${fmtDateOnly(l.dateISO)}</div>`;
      }).join(' ');
    }

    // kitten popup/animation
    function kittenPop(){
      const img = $('#kitten-surprise');
      img.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160"><rect rx="20" width="100%" height="100%" fill="#fff6fb"/><text x="50%" y="50%" font-size="40" text-anchor="middle" dominant-baseline="middle">üê±</text></svg>`);
      img.style.display='block';
      img.style.transform='scale(.8)';
      img.style.opacity='1';
      img.animate([{ transform:'scale(.7) rotate(-8deg)', opacity:0 }, { transform:'scale(1.06) rotate(6deg)', opacity:1 }, { transform:'scale(1) rotate(0deg)', opacity:1 }], { duration:900, easing:'cubic-bezier(.2,.9,.2,1)' });
      setTimeout(()=> img.style.display='none', 2500);
    }

    // ---------- UI rendering ----------
    function renderJobs(){
      $('#jobs-list').innerHTML = (state.jobs||[]).map(j=>{
        const pay = nextPayInfo(j);
        return `<div class="mb-2 p-2 border rounded" role="article">
          <div class="flex items-center justify-between">
            <div><strong>${j.company}</strong> <span class="small">‚Ä¢ ${j.role}</span><div class="small">Salary: ${$('#pref-currency').value||'‚Ç±'}${currency(j.salary)}</div></div>
            <div class="text-right small"><span class="pay-pill">${j.payCycle}</span><div>${fmtDateOnly(pay.payoutISO)}</div></div>
          </div>
        </div>`;
      }).join('') || '<div class="small">No jobs yet</div>';
      // job selector in workday form
      const sel = $('#wd-job'); if(sel) { sel.innerHTML = ''; (state.jobs||[]).forEach(j => { const opt = document.createElement('option'); opt.value = j.id; opt.textContent = `${j.company} ‚Äî ${j.role}`; sel.appendChild(opt); }); }
      $('#active-job-info').textContent = state.jobs[0] ? `${state.jobs[0].company} ‚Ä¢ ${state.jobs[0].role} ‚Ä¢ ${$('#pref-currency').value||'‚Ç±'}${currency(state.jobs[0].salary)}` : '‚Äî';
    }

    function renderTx(){
      const tbody = document.querySelector('#tx-table tbody'); if(!tbody) return; tbody.innerHTML='';
      const list = (state.transactions || []).slice().sort((a,b) => b.date.localeCompare(a.date));
      for(const t of list){
        const tr = document.createElement('tr'); tr.innerHTML = `<td>${fmtDateOnly(t.date)}</td><td>${t.desc}</td><td>${t.cat}</td><td class="text-right">${$('#pref-currency').value||'‚Ç±'} ${currency(t.amt)}</td><td>${t.status||''}</td><td><button class="btn-outline btn-tx-edit" data-id="${t.id}" type="button">Edit</button></td>`;
        tbody.appendChild(tr);
      }
      // wire edit buttons
      $$('.btn-tx-edit').forEach(b => b.onclick = (e)=> openTxModal(b.dataset.id));
    }

    // calendar: month view (simple)
    let calendarDate = nowPH();
    function renderCalendar(){
      const grid = $('#calendar-grid'); if(!grid) return;
      grid.innerHTML = '';
      const year = calendarDate.getFullYear(), month = calendarDate.getMonth();
      $('#cal-label').textContent = calendarDate.toLocaleString('en-PH', { month:'long', year:'numeric' });
      const firstWeekday = new Date(year, month, 1).getDay();
      // blanks
      for(let i=0;i<firstWeekday;i++) {
        const blank = document.createElement('div'); blank.className='calendar-day'; blank.setAttribute('aria-hidden','true'); grid.appendChild(blank);
      }
      const days = new Date(year, month+1, 0).getDate();
      for(let d=1; d<=days; d++){
        const iso = `${year}-${pad(month+1)}-${pad(d)}`;
        const cell = document.createElement('div');
        cell.className = 'calendar-day';
        const dayEvents = (state.events||[]).filter(ev => ev.date === iso);
        cell.innerHTML = `<div class="font-semibold small">${pad(d)}</div>` + dayEvents.map(ev => `<div class="small chip ${ev.emoji ? '' : ''}" tabindex="0" role="button" aria-label="${ev.title}">${ev.emoji || guessEmoji(ev.title)} ${ev.title}</div>`).join('');
        // clicking the box opens add event modal for that date
        cell.addEventListener('click', ()=> openEventModal(iso));
        grid.appendChild(cell);
      }
    }

    // ---------- Modals (simple DOM-based) ----------
    // We'll create and inject modal markup into body as needed and ensure Cancel & Save always work
    function openTxModal(txId){
      const tx = (state.transactions||[]).find(t=>t.id===txId) || { id: crypto.randomUUID(), date: todayISO(), desc:'', cat:'Misc', amt:0, status:'planned' };
      const html = `<div role="dialog" aria-modal="true" aria-labelledby="tx-title" class="card" id="modal-tx">
        <h3 id="tx-title">Transaction</h3>
        <div class="mt-2"><label>Date <input id="modal-tx-date" type="date" value="${tx.date}"></label></div>
        <div class="mt-2"><label>Desc <input id="modal-tx-desc" value="${tx.desc}"></label></div>
        <div class="mt-2"><label>Category <input id="modal-tx-cat" value="${tx.cat}"></label></div>
        <div class="mt-2"><label>Amount <input id="modal-tx-amt" type="number" step="0.01" value="${tx.amt}"></label></div>
        <div class="mt-2"><label>Status <select id="modal-tx-status"><option value="planned"${tx.status==='planned'?' selected':''}>Planned</option><option value="actual"${tx.status==='actual'?' selected':''}>Actual</option></select></label></div>
        <div class="mt-3 flex justify-between"><div><button id="tx-cancel" class="btn-outline" type="button">Cancel</button></div><div><button id="tx-save" class="btn" type="button">Save</button></div></div>
      </div>`;
      const wrapper = document.createElement('div'); wrapper.className='modal-overlay'; wrapper.style.position='fixed'; wrapper.style.inset='0'; wrapper.style.display='flex'; wrapper.style.alignItems='center'; wrapper.style.justifyContent='center'; wrapper.style.background='rgba(0,0,0,.25)'; wrapper.innerHTML = html;
      document.body.appendChild(wrapper);
      // focus
      wrapper.querySelector('#modal-tx-desc').focus();
      // handler: cancel
      wrapper.querySelector('#tx-cancel').addEventListener('click', ()=> { wrapper.remove(); });
      wrapper.addEventListener('keydown', e => { if(e.key==='Escape') wrapper.remove(); });
      wrapper.addEventListener('click', (ev) => { if(ev.target === wrapper) wrapper.remove(); });

      wrapper.querySelector('#tx-save').addEventListener('click', ()=> {
        const updated = {
          id: tx.id,
          date: wrapper.querySelector('#modal-tx-date').value,
          desc: wrapper.querySelector('#modal-tx-desc').value,
          cat: wrapper.querySelector('#modal-tx-cat').value,
          amt: Number(wrapper.querySelector('#modal-tx-amt').value) || 0,
          status: wrapper.querySelector('#modal-tx-status').value
        };
        // replace or push
        const idx = (state.transactions||[]).findIndex(x=>x.id===tx.id);
        if(idx>=0) state.transactions[idx] = updated; else state.transactions.unshift(updated);
        saveState(); renderTx(); renderJobs(); wrapper.remove();
      });
    }

    function openEventModal(dateISO = todayISO()){
      const html = `<div role="dialog" aria-modal="true" class="card" id="modal-ev">
        <h3>New Event</h3>
        <div class="mt-2"><label>Date <input id="modal-ev-date" type="date" value="${dateISO}"></label></div>
        <div class="mt-2"><label>Title <input id="modal-ev-title" value=""></label></div>
        <div class="mt-2"><label>Notes <input id="modal-ev-notes" value=""></label></div>
        <div class="mt-2"><label>Emoji <input id="modal-ev-emoji" value="üê±" style="width:80px"></label></div>
        <div class="mt-3 flex justify-between"><div><button id="ev-cancel" class="btn-outline" type="button">Cancel</button></div><div><button id="ev-save" class="btn" type="button">Save</button></div></div>
      </div>`;
      const wrapper = document.createElement('div'); wrapper.className='modal-overlay'; wrapper.style.position='fixed'; wrapper.style.inset='0'; wrapper.style.display='flex'; wrapper.style.alignItems='center'; wrapper.style.justifyContent='center'; wrapper.style.background='rgba(0,0,0,.25)'; wrapper.innerHTML = html;
      document.body.appendChild(wrapper);
      wrapper.querySelector('#ev-cancel').addEventListener('click', ()=> wrapper.remove());
      wrapper.addEventListener('keydown', e => { if(e.key==='Escape') wrapper.remove(); });
      wrapper.addEventListener('click', (ev) => { if(ev.target === wrapper) wrapper.remove(); });
      wrapper.querySelector('#ev-save').addEventListener('click', ()=>{
        const ev = {
          id: crypto.randomUUID(),
          date: wrapper.querySelector('#modal-ev-date').value,
          title: wrapper.querySelector('#modal-ev-title').value || 'Event',
          notes: wrapper.querySelector('#modal-ev-notes').value || '',
          emoji: wrapper.querySelector('#modal-ev-emoji').value || 'üê±'
        };
        state.events = state.events || []; state.events.push(ev); saveState(); renderCalendar(); wrapper.remove();
      });
    }

    // ---------- wiring & interactions ----------
    function bindUI(){
      // Tabs
      $$('[role="tab"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          $$('[role="tab"]').forEach(b=>b.setAttribute('aria-selected','false'));
          btn.setAttribute('aria-selected','true');
          const tab = btn.dataset.tab;
          $$('main > section').forEach(s => s.classList.add('hidden'));
          const panel = document.getElementById('panel-' + tab);
          if(panel) panel.classList.remove('hidden');
          // add body class for per-tab style
          document.body.className = document.body.className.split(' ').filter(c=>!c.startsWith('tab-')).join(' ') + ' tab-' + tab;
          if(tab === 'calendar') renderCalendar();
          if(tab === 'transactions') renderTx();
          if(tab === 'salary') renderJobs();
        });
      });

      // compute & sync paychecks
      $('#compute-paycheck').addEventListener('click', ()=>{
        const jid = $('#wd-job').value;
        const job = (state.jobs||[]).find(j=>j.id===jid);
        if(!job) { alert('Select a job'); return; }
        const now = todayISO();
        const cov = coverageForAnchorISO(now, job.payCycle || 'monthly');
        const res = computePaycheck(job, cov.startISO, cov.endISO);
        $('#paystub-preview').innerHTML = `<div><strong>${job.company}</strong> ‚Ä¢ ${job.role}</div><div class="small">Period: ${fmtDateOnly(cov.startISO)} ‚Äî ${fmtDateOnly(cov.endISO)}</div><div class="mt-2 small">Expected: ${$('#pref-currency').value||'‚Ç±'}${currency(res.expected)}</div><div class="mt-2 small">Pay date: ${fmtDateOnly(cov.payoutISO)}</div>`;
      });

      $('#sync-paycheck').addEventListener('click', ()=>{
        const jid = $('#wd-job').value;
        const job = (state.jobs||[]).find(j=>j.id===jid);
        if(!job) { alert('Select a job'); return; }
        const now = todayISO();
        const cov = coverageForAnchorISO(now, job.payCycle || 'monthly');
        // compute expected
        const res = computePaycheck(job, cov.startISO, cov.endISO);
        const tx = { id: crypto.randomUUID(), date: cov.payoutISO, desc: `${job.company} paycheck`, cat:'Job', amt: Number(res.expected), status:'planned' };
        state.transactions = state.transactions || []; state.transactions.unshift(tx); saveState(); renderTx();
        notify({ title:'Paycheck synced', body:`${job.company} ‚Äî ${fmtDateOnly(cov.payoutISO)}`, icon:'üí∞' });
      });

      // jobs & workday wiring
      $('#add-job').addEventListener('click', ()=> {
        const j = { id: crypto.randomUUID(), company: prompt('Company')||'Company', role: prompt('Role')||'Role', salary: Number(prompt('Monthly salary (‚Ç±)')||0), payCycle: prompt('PayCycle: monthly | biweekly | weekly','biweekly') || 'biweekly', workdays: [] };
        state.jobs.push(j); saveState(); renderJobs(); notify({ title:'Job added', body: `${j.company} ‚Ä¢ ${j.payCycle}`, icon:'üêæ' });
      });

      $('#wd-add').addEventListener('click', ()=> {
        const jobId = $('#wd-job').value;
        const job = (state.jobs||[]).find(j=>j.id===jobId);
        if(!job) return alert('Select job');
        const rec = { id: crypto.randomUUID(), date: $('#wd-date').value || todayISO(), hoursWorked: Number($('#wd-hours').value) || 0, overtimeHours: Number($('#wd-ot').value) || 0, deductions: Number($('#wd-ded').value) || 0 };
        job.workdays = job.workdays || [];
        job.workdays.push(rec);
        saveState(); renderJobs(); showToast({ title:'Workday added', text:`${job.company} ‚Ä¢ ${fmtDateOnly(rec.date)}`, icon:'üìù' });
      });

      // tx add
      $('#add-tx').addEventListener('click', ()=> openTxModal());

      // search
      $('#tx-search').addEventListener('input', (e)=> {
        const q = e.target.value.toLowerCase();
        const tbody = document.querySelector('#tx-table tbody'); if(!tbody) return;
        tbody.querySelectorAll('tr').forEach(tr => {
          const visible = q.length === 0 || tr.textContent.toLowerCase().includes(q);
          tr.style.display = visible ? '' : 'none';
        });
      });

      // calendar navigation
      $('#cal-prev').addEventListener('click', ()=> { calendarDate.setMonth(calendarDate.getMonth() - 1); renderCalendar(); });
      $('#cal-next').addEventListener('click', ()=> { calendarDate.setMonth(calendarDate.getMonth() + 1); renderCalendar(); });
      $('#add-event').addEventListener('click', ()=> openEventModal());

      // notification toggle
      $('#notif-toggle').addEventListener('click', async function(){
        const enabled = this.getAttribute('aria-pressed') === 'true';
        if(!enabled){
          const ok = await ensureNotificationPermission();
          if(!ok) { alert('Please allow notifications in your browser for reminders to work'); return; }
          this.setAttribute('aria-pressed','true'); this.textContent = 'Reminders on';
          // start periodic reminder ticker
          if(remindersTicker) clearInterval(remindersTicker);
          checkAndNotify(); remindersTicker = setInterval(checkAndNotify, 60*1000); // every minute
        } else {
          this.setAttribute('aria-pressed','false'); this.textContent = 'Enable reminders';
          if(remindersTicker) clearInterval(remindersTicker);
        }
      });

      // "Kitten surprise" button
      $('#surprise-btn').addEventListener('click', ()=> { kittenPop(); notify({ title:'A little surprise!', body:'You found a kitten surprise üéÅ', icon:'üê±' }); });

      // initial populate select and tables
      renderJobs(); renderTx(); renderCalendar();
    }

    // ---------- boot ----------
    function boot(){
      loadState(); seed(); bindUI(); // start clock
      setInterval(()=> { $('#manila-clock').textContent = nowPH().toLocaleTimeString('en-PH', { hour12:true, hour:'numeric', minute:'2-digit', second:'2-digit' }); }, 1000);
      // schedule reminders check every 60s if notifications already enabled
      if($('#notif-toggle').getAttribute('aria-pressed')==='true'){ remindersTicker = setInterval(checkAndNotify, 60*1000); }
      // initial small checks
      setTimeout(()=> { checkAndNotify(); }, 1000);
      // Service worker: register and listen for updates
      if('serviceWorker' in navigator){
        navigator.serviceWorker.register('/lexi-sw.js').then(reg=>{
          reg.addEventListener('updatefound', ()=>{
            notify({ title:'App update', body:'New version downloaded ‚Äî refresh to apply', icon:'‚ú®' });
          });
        }).catch(()=>console.warn('sw failed'));
      }
    }

    // expose to window for debugging
    window.lexi = { state, saveState, checkAndNotify };

    // run
    boot();
  })();
  </script>
</body>
</html>
