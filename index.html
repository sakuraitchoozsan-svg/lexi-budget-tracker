<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Budget Tracker</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Tailwind (simple CDN version) -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <style>
    :root{
      --pink-100:#fff1f6; --pink-200:#ffe6f2; --pink-300:#ffd6ea; --pink-400:#ffb6d9; --ink:#6b1233;
    }
    body{ background: linear-gradient(180deg,var(--pink-100),#fff); color:var(--ink); font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    header{ background: linear-gradient(90deg,var(--pink-200),var(--pink-300)); padding:1rem; border-bottom:1px solid rgba(107,18,51,.06); }
    .card{ background:#fff; border-radius:12px; padding:1rem; box-shadow:0 8px 30px rgba(107,18,51,.04); border:1px solid rgba(255,182,217,.35); }
    .tab-btn{ padding:.5rem .8rem; border-radius:999px; background:transparent; border:1px solid transparent; cursor:pointer; }
    .tab-btn[aria-selected="true"]{ background:linear-gradient(90deg,var(--pink-400),var(--pink-300)); color:white; box-shadow:0 8px 18px rgba(255,149,198,.12); }
    .small{ font-size:.85rem; color:#5a2a44; }
    .chip{ display:inline-block; padding:.2rem .5rem; border-radius:999px; font-size:.78rem; }
    .chip-income{ background:linear-gradient(90deg,#e6fff5,#e6fff0); color:#0b6b3a; }
    .chip-exp{ background:linear-gradient(90deg,#fff0f2,#fff6f9); color:#7b1233; }
    .kitten-small{ width:44px; height:44px; border-radius:10px; }
    .visually-hidden{ position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap; }
    /* loading */
    #loading-screen{ position:fixed; inset:0; background:linear-gradient(180deg,var(--pink-100),#fff); z-index:9999; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:12px; }
    /* toast */
    #toast-wrap{ position:fixed; right:18px; top:18px; z-index:9999; display:flex; flex-direction:column; gap:8px; }
    .toast{ background:#fff0f6; border:1px solid #ffd6ea; padding:10px 12px; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.08); display:flex; gap:10px; align-items:flex-start; }
  </style>
</head>
<body>
  <!-- Loading splash (always hides after JS init) -->
  <div id="loading-screen" aria-hidden="true">
    <!-- small embedded kitten GIF (tiny placeholder) -->
    <img alt="kitten" src="data:image/gif;base64,R0lGODlhEAAQAPIAAP///wAAAMLCwkJCQmZmZjY2No6OjgAAAAAAAAAAACH5BAAAAAAALAAAAAAQABAAAAM6CLrc/jDKSau9OOvNu/9gKI5kiWmKpaoaKqubCsCzPcCzPdCzPcCzPcAAOw==" width="90" height="90" />
    <div class="text-lg font-semibold">Budget Tracker — loading kittens...</div>
  </div>

  <!-- Header -->
  <header class="max-w-5xl mx-auto flex items-start md:items-center justify-between gap-4">
    <div>
      <h1 class="text-2xl font-bold">Budget Tracker</h1>
      <div class="mt-1 small">
        <label>Name: <span id="profile-name" contenteditable="true" role="textbox" aria-label="Edit name">Lexi Natividad Tamot</span></label><br>
        <label>Phone: <span id="profile-phone" contenteditable="true" role="textbox" aria-label="Edit phone">09619128418</span></label><br>
        <label>Email: <span id="profile-email" contenteditable="true" role="textbox" aria-label="Edit email">tamotnicko1999@gmail.com</span></label>
      </div>
    </div>

    <div class="text-right">
      <div id="manila-time" class="font-mono text-lg" aria-live="polite">—</div>
      <div id="manila-date-day" class="small mt-1">—</div>
      <div id="daily-quote" class="italic small mt-1">“…”</div>
    </div>
  </header>

  <!-- Tabs -->
  <nav class="max-w-5xl mx-auto mt-4 flex gap-2 px-2" role="tablist" aria-label="Main">
    <button class="tab-btn" role="tab" aria-selected="true" data-tab="dashboard">Dashboard</button>
    <button class="tab-btn" role="tab" aria-selected="false" data-tab="inc-exp">Income & Expenses</button>
    <button class="tab-btn" role="tab" aria-selected="false" data-tab="salary">Salary & Jobs</button>
    <button class="tab-btn" role="tab" aria-selected="false" data-tab="calendar">Calendar</button>
    <button class="tab-btn" role="tab" aria-selected="false" data-tab="settings">Settings</button>
  </nav>

  <main class="max-w-5xl mx-auto p-4 grid gap-6">

    <!-- Dashboard -->
    <section id="panel-dashboard" class="card" role="tabpanel">
      <div class="flex items-center justify-between mb-3">
        <div><h2 class="text-lg font-semibold">Dashboard</h2><div class="small">Income, Expenses, Savings & Goals trends</div></div>
        <div class="small">Balance: <span id="balance">₱0.00</span></div>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <div class="card">
          <h3 class="font-semibold small">Monthly trends</h3>
          <canvas id="chart-trends" height="220" aria-label="Trends chart"></canvas>
        </div>

        <div class="card">
          <h3 class="font-semibold small">Breakdown</h3>
          <div class="mt-2 small">Income this month: <span id="month-income">₱0.00</span></div>
          <div class="mt-1 small">Expenses this month: <span id="month-expense">₱0.00</span></div>
          <div class="mt-1 small">Savings this month: <span id="month-saving">₱0.00</span></div>
          <div class="mt-3" id="dashboard-notes"></div>
        </div>
      </div>
    </section>

    <!-- Income & Expenses -->
    <section id="panel-inc-exp" class="card hidden" role="tabpanel">
      <div class="flex items-center justify-between mb-3">
        <div><h2 class="text-lg font-semibold">Income & Expenses</h2><div class="small">Add income, expenses, or savings/goals</div></div>
        <div>
          <button id="btn-new-entry" class="px-3 py-1 rounded bg-pink-400 text-white">New</button>
        </div>
      </div>

      <div id="entry-form-wrap" class="mb-4 hidden card">
        <form id="entry-form" class="grid gap-2">
          <label class="small">Type
            <select id="entry-type" class="w-full border rounded p-2">
              <option value="income">Income</option>
              <option value="expense">Expense</option>
              <option value="saving">Saving / Goal</option>
            </select>
          </label>
          <label class="small">Description
            <input id="entry-desc" class="w-full border rounded p-2" placeholder="Description" />
          </label>
          <label class="small">Amount (₱)
            <input id="entry-amt" type="number" step="0.01" class="w-full border rounded p-2" placeholder="0.00" />
          </label>
          <div class="flex gap-2">
            <button type="submit" class="px-3 py-1 rounded bg-pink-400 text-white">Save</button>
            <button id="entry-cancel" type="button" class="px-3 py-1 rounded border">Cancel</button>
          </div>
        </form>
      </div>

      <div id="entries-list" class="space-y-2"></div>
    </section>

    <!-- Salary & Jobs -->
    <section id="panel-salary" class="card hidden" role="tabpanel">
      <div class="flex items-center justify-between mb-3">
        <div><h2 class="text-lg font-semibold">Salary & Jobs</h2><div class="small">Add / remove jobs — supports weekly / biweekly (semi-monthly) / monthly</div></div>
        <div><button id="btn-add-job" class="px-3 py-1 rounded bg-pink-400 text-white">Add Job</button></div>
      </div>
      <div id="jobs-list" class="space-y-2"></div>
    </section>

    <!-- Calendar -->
    <section id="panel-calendar" class="card hidden" role="tabpanel">
      <div class="flex items-center justify-between mb-3">
        <div><h2 class="text-lg font-semibold">Calendar</h2><div class="small">Events & reminders</div></div>
        <div><button id="btn-add-event" class="px-3 py-1 rounded bg-pink-400 text-white">Add Event</button></div>
      </div>
      <div id="calendar-list" class="space-y-2"></div>
    </section>

    <!-- Settings -->
    <section id="panel-settings" class="card hidden" role="tabpanel">
      <h2 class="text-lg font-semibold">Settings</h2>
      <div class="grid md:grid-cols-2 gap-3 mt-3">
        <div class="card">
          <div class="small mb-2">Currency</div>
          <input id="pref-currency" class="border rounded p-2" value="₱" />
        </div>

        <div class="card">
          <div class="small mb-2">Avg workdays/month</div>
          <input id="pref-workdays" type="number" class="border rounded p-2" value="22" />
        </div>
      </div>
    </section>

  </main>

  <!-- Toasts -->
  <div id="toast-wrap" aria-live="polite"></div>

  <!-- hidden audio not needed: we use WebAudio chime -->

<script>
/* =========================
   Budget Tracker App JS
   - Manila 12-hour time with date/day
   - Daily quote rotates by date
   - Income/Expense/Saving entries; auto-deduct from income
   - Dashboard chart (Chart.js)
   - Jobs add/remove and pay-cycle logic (semi-monthly: 1-15 paid EOM; 16-EOM paid 15 next month)
   - Notifications: in-app toast + desktop Notification + WebAudio chime
   - Loading fallback / robust try/catch
   ========================= */

(() => {
  const TZ = 'Asia/Manila';
  const LS_KEY = 'lexi_budget_v1';

  // safe selectors
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  // initial state
  let state = {
    entries: [], // { id, type: income|expense|saving, desc, amt, dateISO }
    jobs: [],    // {id, company, salary, payCycle}
    events: []
  };

  // helpers
  const uuid = () => crypto.randomUUID();
  const pad = n => String(n).padStart(2, '0');
  const nowPH = () => new Date(new Date().toLocaleString('en-PH', { timeZone: TZ }));
  const todayISO = () => {
    const d = nowPH();
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  };
  const isoToDMY = iso => { if(!iso) return ''; const [y,m,d] = iso.split('-'); return `${pad(d)}/${pad(m)}/${y}`; };
  const currency = v => (Number(v)||0).toLocaleString('en-PH', {minimumFractionDigits:2});

  // persistence
  function save() { try { localStorage.setItem(LS_KEY, JSON.stringify(state)); } catch(e) { console.warn(e); } }
  function load() { try { const s = localStorage.getItem(LS_KEY); if(s) state = JSON.parse(s); } catch(e){ console.warn(e); } }

  // daily motivational quotes (rotates by date)
  const QUOTES = [
    "Small steps, big results.",
    "One more task — you’ve got this.",
    "Make today count — little wins add up.",
    "Focus on progress, not perfection.",
    "Your work matters — keep going.",
    "Keep calm and carry on — with kittens.",
    "Consistency beats bursts of energy.",
    "One good choice at a time.",
    "You are building momentum every day.",
    "Turn coffees into accomplishments!"
  ];
  function dailyQuote(){
    const d = nowPH(); const idx = (d.getFullYear() + d.getMonth() + d.getDate()) % QUOTES.length; return QUOTES[idx];
  }

  // WebAudio chime
  const audioCtx = typeof AudioContext !== 'undefined' ? new AudioContext() : null;
  function playChime(){
    if(!audioCtx) return;
    try {
      const t = audioCtx.currentTime;
      const o1 = audioCtx.createOscillator();
      const g1 = audioCtx.createGain();
      o1.type = 'sine'; o1.frequency.setValueAtTime(880, t);
      g1.gain.setValueAtTime(0.001, t); g1.gain.exponentialRampToValueAtTime(0.12, t+0.02); g1.gain.exponentialRampToValueAtTime(0.001, t+0.5);
      o1.connect(g1); g1.connect(audioCtx.destination); o1.start(t); o1.stop(t+0.55);
    } catch(e){}
  }

  // Desktop notification helper
  async function notifyDesktop(title, body, tag){
    try {
      if(!('Notification' in window)) return;
      if(Notification.permission === 'granted'){
        new Notification(title, { body, tag, silent: true });
      } else if(Notification.permission !== 'denied'){
        const p = await Notification.requestPermission();
        if(p === 'granted') new Notification(title, { body, tag, silent: true });
      }
    } catch(e){ console.warn(e); }
  }

  // in-app toast
  function showToast(title, text = '', emoji = '🐱') {
    const wrap = $('#toast-wrap');
    const el = document.createElement('div');
    el.className = 'toast';
    el.innerHTML = `<div style="font-size:20px">${emoji}</div><div style="flex:1"><strong>${title}</strong><div class="small">${text}</div></div><div><button aria-label="dismiss" style="background:transparent;border:0;cursor:pointer">OK</button></div>`;
    wrap.appendChild(el);
    el.querySelector('button').onclick = () => el.remove();
    playChime();
    setTimeout(()=> el.remove(), 7000);
  }

  // safe init hide loading
  function hideLoading(){ const s = document.getElementById('loading-screen'); if(s) s.style.display = 'none'; }

  // UI: time + date + quote
  function renderClockAndQuote(){
    const tEl = $('#manila-time'), dEl = $('#manila-date-day'), qEl = $('#daily-quote');
    const d = nowPH();
    // 12-hour
    tEl.textContent = d.toLocaleTimeString('en-PH', { hour: 'numeric', minute:'2-digit', second:'2-digit', hour12: true, timeZone: TZ });
    const dayName = d.toLocaleDateString('en-PH', { weekday: 'long', timeZone: TZ });
    const dateStr = d.toLocaleDateString('en-PH', { year:'numeric', month:'short', day:'numeric', timeZone: TZ });
    dEl.textContent = `${dayName} • ${dateStr}`;
    qEl.textContent = dailyQuote();
  }

  // Chart: trends (monthly sums)
  let trendsChart = null;
  function renderChart(){
    const ctx = document.getElementById('chart-trends').getContext('2d');
    // prepare last 6 months labels and sums
    const now = nowPH();
    const labels = [];
    const incomeData = [], expenseData = [], savingData = [];
    for(let i=5;i>=0;i--){
      const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
      const ym = `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
      labels.push(d.toLocaleDateString('en-PH', { month:'short', year:'numeric' }));
      // sums
      const inc = state.entries.filter(e => e.type==='income' && e.date.startsWith(ym)).reduce((s,n)=>s+Number(n.amt||0),0);
      const exp = state.entries.filter(e => e.type==='expense' && e.date.startsWith(ym)).reduce((s,n)=>s+Number(n.amt||0),0);
      const sav = state.entries.filter(e => e.type==='saving' && e.date.startsWith(ym)).reduce((s,n)=>s+Number(n.amt||0),0);
      incomeData.push(inc); expenseData.push(exp); savingData.push(sav);
    }
    if(trendsChart) trendsChart.destroy();
    trendsChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'Income', data: incomeData, fill:false, tension:0.3, borderColor:'#10b981' },
          { label: 'Expenses', data: expenseData, fill:false, tension:0.3, borderColor:'#ef4444' },
          { label: 'Savings', data: savingData, fill:false, tension:0.3, borderColor:'#6366f1' }
        ]
      },
      options: { responsive:true, plugins:{ legend:{position:'bottom'} } }
    });
  }

  // Dashboard numbers
  function renderDashboardNumbers(){
    const thisMonthYM = (()=>{ const d = nowPH(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}`; })();
    const monthIncome = state.entries.filter(e=> e.type==='income' && e.date.startsWith(thisMonthYM)).reduce((s,n)=>s+Number(n.amt||0),0);
    const monthExpense = state.entries.filter(e=> e.type==='expense' && e.date.startsWith(thisMonthYM)).reduce((s,n)=>s+Number(n.amt||0),0);
    const monthSaving = state.entries.filter(e=> e.type==='saving' && e.date.startsWith(thisMonthYM)).reduce((s,n)=>s+Number(n.amt||0),0);
    $('#month-income').textContent = `₱${currency(monthIncome)}`;
    $('#month-expense').textContent = `₱${currency(monthExpense)}`;
    $('#month-saving').textContent = `₱${currency(monthSaving)}`;

    // balance = all incomes - (expenses + savings)
    const allIncome = state.entries.filter(e=>e.type==='income').reduce((s,n)=>s+Number(n.amt||0),0);
    const allExpense = state.entries.filter(e=>e.type==='expense').reduce((s,n)=>s+Number(n.amt||0),0);
    const allSaving = state.entries.filter(e=>e.type==='saving').reduce((s,n)=>s+Number(n.amt||0),0);
    $('#balance').textContent = `₱${currency(allIncome - (allExpense + allSaving))}`;
  }

  // render entries list
  function renderEntries(){
    const wrap = $('#entries-list');
    wrap.innerHTML = '';
    // newest first
    const list = state.entries.slice().sort((a,b)=> b.date.localeCompare(a.date));
    if(!list.length) wrap.innerHTML = '<div class="small">No entries yet.</div>';
    list.forEach(e => {
      const el = document.createElement('div'); el.className = 'p-3 border rounded flex items-center justify-between';
      el.innerHTML = `<div><div class="font-medium">${e.desc || (e.type==='income'?'Income':'Expense')}</div><div class="small">${isoToDMY(e.date)}</div></div>
                      <div class="text-right"><div class="font-semibold">${e.type==='income'? '₱'+currency(e.amt) : '- ₱'+currency(e.amt)}</div>
                      <div class="small"><button data-id="${e.id}" class="btn-delete-entry text-xs mt-1" style="background:transparent;border:0;color:#a11">Delete</button></div></div>`;
      wrap.appendChild(el);
    });
    // wire deletes
    $$('.btn-delete-entry').forEach(b=> b.onclick = (ev)=> {
      const id = b.dataset.id;
      state.entries = state.entries.filter(x=>x.id!==id);
      save(); refreshAll();
      showToast('Entry removed','', '🐾');
    });
  }

  // render jobs
  function renderJobs(){
    const wrap = $('#jobs-list'); wrap.innerHTML = '';
    if(!state.jobs.length) wrap.innerHTML = '<div class="small">No jobs yet.</div>';
    state.jobs.forEach(j => {
      const el = document.createElement('div'); el.className='p-3 border rounded flex items-center justify-between';
      el.innerHTML = `<div><div class="font-medium">${j.company}</div><div class="small">${j.role} • ${j.payCycle}</div></div>
                      <div class="text-right small"><div>₱${currency(j.salary)}</div><div><button data-id="${j.id}" class="btn-remove-job" style="background:transparent;border:0;color:#a11">Remove</button></div></div>`;
      wrap.appendChild(el);
    });
    $$('.btn-remove-job').forEach(b => b.onclick = () => {
      state.jobs = state.jobs.filter(x=>x.id!==b.dataset.id);
      save(); renderJobs(); showToast('Job removed','', '🐱');
    });
  }

  // events
  function renderEvents(){
    const wrap = $('#calendar-list'); wrap.innerHTML = '';
    if(!state.events.length) wrap.innerHTML = '<div class="small">No events yet.</div>';
    state.events.forEach(ev => {
      const el = document.createElement('div'); el.className='p-3 border rounded flex items-center justify-between';
      el.innerHTML = `<div><div class="font-medium">${ev.emoji || '🐱'} ${ev.title}</div><div class="small">${isoToDMY(ev.date)}</div></div>
                      <div class="small"><button data-id="${ev.id}" class="btn-remove-event" style="background:transparent;border:0;color:#a11">Remove</button></div>`;
      wrap.appendChild(el);
    });
    $$('.btn-remove-event').forEach(b => b.onclick = () => {
      state.events = state.events.filter(e=>e.id!==b.dataset.id); save(); renderEvents(); showToast('Event removed','', '📅');
    });
  }

  // pay period coverage helper (semi-monthly = biweekly label -> 1-15 paid EOM, 16-EOM paid 15 next month)
  function coverageForAnchorISO(anchorISO, payCycle){
    const [y,m,d] = anchorISO.split('-').map(Number);
    if(payCycle === 'monthly'){
      const start = `${y}-${pad(m)}-01`;
      const end = new Date(y, m, 0); // last day
      return { startISO: start, endISO: `${y}-${pad(m)}-${pad(end.getDate())}`, payoutISO: `${y}-${pad(m)}-${pad(end.getDate())}` };
    }
    if(payCycle === 'biweekly' || payCycle === 'semi-monthly'){
      if(d <= 15){
        const start = `${y}-${pad(m)}-01`;
        const end = `${y}-${pad(m)}-15`;
        const eom = new Date(y, m, 0);
        return { startISO: start, endISO: end, payoutISO: `${y}-${pad(m)}-${pad(eom.getDate())}` };
      } else {
        const start = `${y}-${pad(m)}-16`;
        const eom = new Date(y, m, 0);
        const next = new Date(y, m, 1); next.setMonth(next.getMonth()+1);
        return { startISO: start, endISO: `${y}-${pad(m)}-${pad(eom.getDate())}`, payoutISO: `${next.getFullYear()}-${pad(next.getMonth()+1)}-15` };
      }
    }
    // weekly fallback (Mon-Sun)
    const js = new Date(anchorISO + 'T00:00:00');
    const weekday = (js.getDay() + 6) % 7;
    const startDt = new Date(js); startDt.setDate(js.getDate() - weekday);
    const endDt = new Date(startDt); endDt.setDate(startDt.getDate() + 6);
    const payoutDt = new Date(endDt); payoutDt.setDate(endDt.getDate() + 1);
    return { startISO: toISO(startDt), endISO: toISO(endDt), payoutISO: toISO(payoutDt) };
  }

  function toISO(d){ const off = d.getTimezoneOffset(); return new Date(d.getTime() - off*60000).toISOString().slice(0,10); }

  // entry form handling
  function openEntryForm(){
    $('#entry-form-wrap').classList.remove('hidden');
    $('#entry-desc').value = '';
    $('#entry-amt').value = '';
    $('#entry-type').value = 'expense';
    $('#entry-desc').focus();
  }
  function closeEntryForm(){ $('#entry-form-wrap').classList.add('hidden'); }

  // add new entry
  function addEntry(type, desc, amt, dateISO = todayISO()){
    state.entries.push({ id: uuid(), type, desc, amt: Number(amt||0), date: dateISO });
    save(); refreshAll();
  }

  // add job modal (prompt-based simple)
  function addJob(){
    const company = prompt('Company name') || 'Company';
    const role = prompt('Role') || 'Role';
    const salary = Number(prompt('Monthly salary (numeric)') || 0);
    const payCycle = prompt('Pay cycle: monthly | biweekly | weekly', 'biweekly') || 'biweekly';
    const job = { id: uuid(), company, role, salary, payCycle };
    state.jobs.push(job); save(); renderJobs(); showToast('Job added', company, '💼');
  }

  // add event
  function addEvent(){
    const title = prompt('Event title') || 'Event';
    const emoji = prompt('Emoji (e.g. 🎂, 📅, 🐱)') || '🐱';
    const date = prompt('Date (YYYY-MM-DD)') || todayISO();
    state.events.push({ id: uuid(), title, emoji, date }); save(); renderEvents(); showToast('Event added', title, emoji);
  }

  // checks for reminders (paydays, bills, events) within lookahead days
  function checkReminders(lookaheadDays = 2){
    const today = nowPH(); today.setHours(0,0,0,0);
    const end = new Date(today); end.setDate(today.getDate() + Number(lookaheadDays));
    const startISO = toISO(today), endISO = toISO(end);
    // jobs -> check payout dates within window
    state.jobs.forEach(job => {
      // check current and next few periods
      let anchor = startISO;
      for(let i=0;i<3;i++){
        const cov = coverageForAnchorISO(anchor, job.payCycle || 'monthly');
        if(cov.payoutISO >= startISO && cov.payoutISO <= endISO){
          const title = `Payday — ${job.company}`;
          const body = `Payout ${isoToDMY(cov.payoutISO)} (${isoToDMY(cov.startISO)} - ${isoToDMY(cov.endISO)})`;
          showToast(title, body, '💰'); notifyDesktop(title, body, 'payday-'+job.id); playChime();
        }
        // move anchor to day after this end
        const nextAnchorDate = new Date(cov.endISO + 'T00:00:00'); nextAnchorDate.setDate(nextAnchorDate.getDate()+1);
        anchor = toISO(nextAnchorDate);
      }
    });

    // events
    state.events.forEach(ev => {
      if(ev.date >= startISO && ev.date <= endISO){
        const title = `${ev.emoji || '📅'} ${ev.title}`;
        showToast(title, isoToDMY(ev.date), ev.emoji || '📅');
        notifyDesktop(ev.title, isoToDMY(ev.date), 'event-'+ev.id);
      }
    });
  }

  // desktop notifications wrapper
  async function notifyDesktop(title, body, tag){
    await notifyRequest();
    if(Notification.permission === 'granted') new Notification(title, { body, tag, silent: true });
  }

  async function notifyRequest(){
    if(!('Notification' in window)) return;
    if(Notification.permission === 'granted') return;
    if(Notification.permission !== 'denied') await Notification.requestPermission();
  }

  // UI wiring
  function bindUI(){
    // tabs
    $$('[role="tab"]').forEach(btn => {
      btn.addEventListener('click', () => {
        $$('[role="tab"]').forEach(t => t.setAttribute('aria-selected','false'));
        btn.setAttribute('aria-selected','true');
        const tab = btn.dataset.tab;
        $$('main > section.card, main > section.card.hidden').forEach(s => s.classList.add('hidden'));
        const panel = document.getElementById('panel-' + tab);
        if(panel) panel.classList.remove('hidden');
        // render contextually
        if(tab === 'dashboard'){ renderChart(); renderDashboardNumbers(); }
        if(tab === 'inc-exp'){ renderEntries(); }
        if(tab === 'salary'){ renderJobs(); }
        if(tab === 'calendar'){ renderEvents(); }
      });
    });

    // entry new / form
    $('#btn-new-entry').addEventListener('click', openEntryForm);
    $('#entry-cancel').addEventListener('click', closeEntryForm);
    $('#entry-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const type = $('#entry-type').value;
      const desc = $('#entry-desc').value.trim() || (type==='income'? 'Income':'Expense');
      const amt = Number($('#entry-amt').value) || 0;
      if(!amt || amt <= 0){ alert('Enter amount'); return; }
      addEntry(type, desc, amt, todayISO());
      closeEntryForm(); showToast(type==='income'?'Income added':'Entry added', `${desc} • ₱${currency(amt)}`, type==='income' ? '💰' : (type==='expense' ? '💸' : '🎯'));
    });

    // add job
    $('#btn-add-job').addEventListener('click', addJob);

    // add event
    $('#btn-add-event').addEventListener('click', addEvent);

    // initial panel show
    document.querySelector('[role="tab"][aria-selected="true"]').click();
  }

  // refresh UI & chart
  function refreshAll(){
    renderChart();
    renderDashboardNumbers();
    renderEntries();
    renderJobs();
    renderEvents();
  }

  // startup with try/catch and hide loading either way
  async function boot(){
    try {
      load();
      // safe defaults
      if(!state.entries) state.entries = [];
      if(!state.jobs) state.jobs = [];
      if(!state.events) state.events = [];

      // render immediately basic UI
      renderClockAndQuote();
      setInterval(renderClockAndQuote, 1000);

      bindUI();
      refreshAll();

      // check reminders automatically (lookahead 2 days)
      await notifyRequest();
      checkReminders(2);
      setInterval(()=> checkReminders(2), 60*1000 * 10); // every 10 minutes

      // auto-save every 5s (safety)
      setInterval(save, 5000);

    } catch (err) {
      console.error('Startup error', err);
      showToast('Startup error','Check console (F12) for details','🐞');
    } finally {
      hideLoading();
    }
  }

  // expose small API for debugging
  window.lexiApp = { state, save, load, refreshAll };

  // run
  boot();

})();
</script>

</body>
</html>
