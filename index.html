<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Budget Tracker ‚Äî Pastel Pink Kitten Lover</title>

  <!-- Tailwind CDN -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --pink:#ff89b8; --pink-deep:#d62f6b; --muted:#6b7280; --bg1:#fff0f6; --kitten:#fff6fb;
    }
    html,body{height:100%}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; margin:0;
      background: linear-gradient(180deg,#fff7fb,#fff0f6);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    header{background:linear-gradient(90deg,#fff7fb,#fff0f6); box-shadow:0 6px 18px rgba(15,23,42,0.04); border-bottom:1px solid rgba(0,0,0,0.04); padding:1rem}
    .card{background:white;border-radius:1rem;padding:1rem;box-shadow:0 8px 24px rgba(15,23,42,0.05)}
    .chip{display:inline-block;padding:.25rem .6rem;border-radius:999px;background:linear-gradient(90deg,var(--pink),var(--pink-deep));color:white;font-weight:700}
    .badge-due{display:inline-flex;align-items:center;gap:.4rem;padding:.25rem .5rem;border-radius:.6rem;background:linear-gradient(90deg,#ffd6e8,#ffb3d6);color:var(--pink-deep);font-weight:700}
    .blink{animation:blink 1s step-start infinite}
    @keyframes blink{50%{opacity:.25}}
    .modal-backdrop{position:fixed;inset:0;background:rgba(11,10,11,0.45);display:none;align-items:center;justify-content:center;padding:1rem;z-index:80}
    .modal-backdrop.open{display:flex}
    .modal{background:linear-gradient(180deg,#fff,#fff7fb);border-radius:1rem;padding:1rem;width:100%;max-width:720px;border:1px solid rgba(0,0,0,0.04)}
    .tab-btn{padding:.45rem .75rem;border-radius:.75rem;background:transparent;border:1px solid transparent;font-weight:600;transition:all .18s}
    .tab-btn.active{background:linear-gradient(90deg,#ffd6e8,#ffc3df);color:#5b0b3a;box-shadow:0 8px 20px rgba(198,92,148,0.08)}
    .floating-paw{position:fixed;pointer-events:none;font-size:26px;opacity:.12;transform:translate(-50%,-50%);filter:blur(.2px)}
    .quote{font-style:italic;color:#7b1b4b}
    .btn{background:var(--pink);color:white;padding:.45rem .75rem;border-radius:.6rem;border:0;font-weight:700}
    .btn-outline{background:transparent;border:1px solid var(--pink);color:var(--pink);padding:.45rem .75rem;border-radius:.6rem;font-weight:700}
    .small{font-size:.86rem;color:var(--muted)}
    footer{padding:1rem;text-align:center;color:var(--muted);font-size:.85rem}
    .calendar-chip{display:inline-block;padding:.15rem .5rem;border-radius:999px;font-size:.82rem;margin-top:.25rem}
    .chip-bill{background:#ffd6e8;color:#6b0b3a}
    .chip-pay{background:#d6f7e0;color:#0b6b3a}
    .chip-bday{background:#fff0b3;color:#6b4a0b}
    .chip-meet{background:#d6eaff;color:#064e6a}
    .chip-default{background:#efe0ff;color:#4b1a74}
    @media(min-width:768px){ .md-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem } }
    .modal { transform-origin:center center; animation:popIn .18s ease; }
    @keyframes popIn { from { transform: scale(.98); opacity: 0 } to { transform: scale(1); opacity:1 } }
  </style>
</head>
<body>

  <!-- Kitten chime audio (tiny placeholder) -->
  <audio id="kitten-chime" preload="auto">
    <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQAAACAAABkYXRhAAAAAA==" type="audio/mp3">
  </audio>

  <header class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold text-pink-600">Budget Tracker ‚Äî Pastel Pink Kitten</h1>
      <div class="flex items-center gap-3 mt-1">
        <div id="manila-clock" class="text-lg font-semibold text-gray-700"></div>
        <div id="manila-date" class="text-sm text-gray-500"></div>
      </div>
      <div id="motivational-quote" class="quote mt-1">Keep going, Lexi! üêæ</div>
    </div>
    <div class="text-right">
      <div class="chip">Cute & Helpful</div>
      <div class="small mt-2">Timezone: Asia/Manila (PHT)</div>
    </div>
  </header>

  <main class="p-4 max-w-6xl mx-auto">
    <!-- Top tabs -->
    <nav class="flex gap-2 mb-4">
      <button class="tab-btn active" data-panel="panel-dashboard">Dashboard</button>
      <button class="tab-btn" data-panel="panel-transactions">Income & Expenses</button>
      <button class="tab-btn" data-panel="panel-savings">Savings & Goals</button>
      <button class="tab-btn" data-panel="panel-salary">Jobs</button>
      <button class="tab-btn" data-panel="panel-calendar">Calendar</button>
      <button class="tab-btn" data-panel="panel-profile">Profile</button>
    </nav>

    <!-- Dashboard -->
    <section id="panel-dashboard" class="card">
      <div class="md-grid-3">
        <div>
          <h3 class="font-medium">Overview</h3>
          <div id="panel-summary" class="mt-2 small"></div>
        </div>
        <div>
          <h3 class="font-medium">Upcoming</h3>
          <div id="panel-next-bills" class="mt-2 small"></div>
          <div id="panel-paychecks" class="mt-2 small"></div>
        </div>
        <div>
          <h3 class="font-medium">Recent</h3>
          <div id="panel-recent-tx" class="mt-2 small"></div>
        </div>
      </div>

      <div class="mt-4">
        <canvas id="chart-monthly"></canvas>
      </div>
    </section>

    <!-- Income & Expenses -->
    <section id="panel-transactions" class="card hidden">
      <div class="flex items-center justify-between">
        <h3 class="font-medium">Income & Expenses</h3>
        <div class="flex items-center gap-2">
          <input id="global-search" placeholder="Search..." class="border rounded px-2 py-1 small" />
          <button id="add-tx-btn" class="btn">+ Add</button>
        </div>
      </div>

      <div class="mt-3 overflow-x-auto">
        <table id="tx-table" class="w-full text-sm">
          <thead><tr><th>Date</th><th>Type</th><th>Description</th><th>Category</th><th>Amount</th><th>Balance</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Savings -->
    <section id="panel-savings" class="card hidden">
      <div class="flex items-center justify-between">
        <h3 class="font-medium">Savings & Goals</h3>
        <button id="add-saving-btn" class="btn">+ Add</button>
      </div>
      <div id="savings-list" class="mt-3"></div>
    </section>

    <!-- Jobs & Salary -->
    <section id="panel-salary" class="card hidden">
      <div class="flex items-center justify-between">
        <h3 class="font-medium">Jobs & Paycheck Tracker</h3>
        <button id="add-job-btn" class="btn">+ Add Job</button>
      </div>

      <div id="salary-jobs-list" class="mt-3"></div>

      <div class="mt-4 card">
        <h4 class="font-semibold">Paystub Preview</h4>
        <div id="paystub-preview" class="mt-2 small"></div>
        <div class="mt-2 flex gap-2">
          <button id="compute-paycheck-btn" class="btn">Compute Paycheck</button>
          <button id="sync-paycheck-btn" class="btn-outline">Sync Paycheck ‚Üí Transactions</button>
        </div>
        <div id="paycheck-compare" class="mt-2 small"></div>
      </div>
    </section>

    <!-- Calendar -->
    <section id="panel-calendar" class="card hidden">
      <div class="flex items-center gap-2">
        <button id="prev-month" class="btn-outline">‚Äπ</button>
        <div id="calendar-month-label" class="font-medium"></div>
        <button id="next-month" class="btn-outline">‚Ä∫</button>
        <div class="ml-auto small">Timezone: Asia/Manila</div>
      </div>

      <div id="calendar-grid" class="grid grid-cols-7 gap-2 mt-3"></div>
      <div id="calendar-events" class="mt-3"></div>
    </section>

    <!-- Profile -->
    <section id="panel-profile" class="card hidden">
      <h3 class="font-medium">Profile</h3>
      <div class="mt-2 grid gap-2">
        <input id="profile-name" placeholder="Name" class="border rounded px-2 py-1" value="Lexi Natividad Tamot" />
        <input id="profile-phone" placeholder="Phone" class="border rounded px-2 py-1" value="09619128418" />
        <input id="profile-email" placeholder="Email" class="border rounded px-2 py-1" value="tamotnicko1999@gmail.com" />
        <div class="flex justify-end gap-2 mt-2">
          <button id="profile-save-btn" class="btn">Save</button>
        </div>
      </div>
    </section>

  </main>

  <footer>Lexi ‚Äî Pastel Pink Kitten Budget Tracker ‚Ä¢ Asia/Manila timezone</footer>

  <!-- MODALS -->
  <div id="modal-transaction" class="modal-backdrop">
    <div class="modal">
      <h3 class="font-semibold">Add / Edit Transaction</h3>
      <div class="mt-2 grid gap-2">
        <input id="tx-form-date" type="date" class="border rounded px-2 py-1" />
        <select id="tx-form-type" class="border rounded px-2 py-1">
          <option value="income">Income</option>
          <option value="expense">Expense</option>
          <option value="saving">Saving / Goal</option>
        </select>
        <input id="tx-form-desc" placeholder="Description" class="border rounded px-2 py-1" />
        <input id="tx-form-cat" placeholder="Category" class="border rounded px-2 py-1" />
        <input id="tx-form-amt" type="number" placeholder="Amount" class="border rounded px-2 py-1" />
        <input id="tx-form-notes" placeholder="Notes" class="border rounded px-2 py-1" />
        <div class="flex justify-between mt-3">
          <div>
            <button id="tx-cancel-btn" class="btn-outline">Cancel</button>
            <button id="tx-delete-btn" class="btn-outline text-red-600 hidden">Delete</button>
          </div>
          <button id="tx-save-btn" class="btn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modal-job" class="modal-backdrop">
    <div class="modal">
      <h3 class="font-semibold">Add / Edit Job</h3>
      <div class="mt-2 grid gap-2">
        <input id="job-form-company" placeholder="Company" class="border rounded px-2 py-1" />
        <input id="job-form-role" placeholder="Role" class="border rounded px-2 py-1" />
        <input id="job-form-salary" type="number" placeholder="Monthly salary" class="border rounded px-2 py-1" />
        <select id="job-form-paycycle" class="border rounded px-2 py-1">
          <option value="monthly">Monthly</option>
          <option value="biweekly">Bi-weekly</option>
          <option value="weekly">Weekly</option>
        </select>
        <label class="small"><input id="job-form-fulltime" type="checkbox"> Full-time</label>
        <div class="flex justify-between mt-3">
          <div><button id="job-cancel-btn" class="btn-outline">Cancel</button><button id="job-delete-btn" class="btn-outline text-red-600 hidden">Delete</button></div>
          <button id="job-save-btn" class="btn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modal-bill" class="modal-backdrop">
    <div class="modal">
      <h3 class="font-semibold">Add / Edit Bill</h3>
      <div class="mt-2 grid gap-2">
        <input id="bill-form-name" placeholder="Bill name" class="border rounded px-2 py-1" />
        <input id="bill-form-day" type="number" min="1" max="31" placeholder="Due day (1-31)" class="border rounded px-2 py-1" />
        <input id="bill-form-amt" type="number" placeholder="Amount" class="border rounded px-2 py-1" />
        <label class="small"><input id="bill-form-auto" type="checkbox"> Auto-generate transaction each month</label>
        <div class="flex justify-between mt-3">
          <div><button id="bill-cancel-btn" class="btn-outline">Cancel</button><button id="bill-delete-btn" class="btn-outline text-red-600 hidden">Delete</button></div>
          <button id="bill-save-btn" class="btn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modal-event" class="modal-backdrop">
    <div class="modal">
      <h3 class="font-semibold">Add / Edit Event</h3>
      <div class="mt-2 grid gap-2">
        <input id="event-form-title" placeholder="Title" class="border rounded px-2 py-1" />
        <input id="event-form-emoji" placeholder="Emoji (e.g. üéâ)" class="border rounded px-2 py-1" />
        <textarea id="event-form-notes" placeholder="Special notes" class="border rounded px-2 py-1"></textarea>
        <input id="event-form-date" type="date" class="border rounded px-2 py-1" />
        <div class="flex justify-between mt-3">
          <div><button id="event-delete-btn" class="btn-outline text-red-600 hidden">Delete</button></div>
          <div class="flex gap-2">
            <button id="event-cancel-btn" class="btn-outline">Cancel</button>
            <button id="event-save-btn" class="btn">Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===== Lexi App: merged full index.html =====
  - PHT timezone clock + date + daily quote
  - IndexedDB autosave + localStorage fallback
  - Jobs, Transactions (income/expense/saving), Bills, Events
  - Bi-weekly / weekly / monthly paycheck cutoff logic
  - Charts via Chart.js
  - All add/edit/delete modals wired
  - BroadcastChannel sync and SW registration hook
======================================== */

(() => {
  const TZ = 'Asia/Manila';
  const DB_NAME = 'lexi_db_v1';
  const DB_STORE = 'lexi_store_v1';
  const DEBOUNCE_MS = 800;

  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const todayISO = ()=> new Date().toLocaleString('sv-SE',{timeZone:TZ}).split(' ')[0];
  const currencyFmt = v => (Number(v)||0).toLocaleString('en-PH',{minimumFractionDigits:2});
  const formatDDMMYYYY = iso => { if(!iso) return ''; const d=new Date(iso); return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`; };

  // state
  let state = { transactions:[], bills:[], jobs:[], budgets:[], savings:[], events:[] };

  // IndexedDB helpers
  let db = null;
  function openDB(){
    return new Promise((res,rej)=>{
      const r = indexedDB.open(DB_NAME,1);
      r.onupgradeneeded = e => { db=e.target.result; if(!db.objectStoreNames.contains(DB_STORE)) db.createObjectStore(DB_STORE,{keyPath:'key'}); };
      r.onsuccess = e => { db=e.target.result; res(db); };
      r.onerror = e => rej(e);
    });
  }
  async function idbPut(key,val){ if(!db) await openDB(); return new Promise((res,rej)=>{ const tx = db.transaction(DB_STORE,'readwrite'); const st = tx.objectStore(DB_STORE); st.put({key,val}); tx.oncomplete = ()=>res(); tx.onerror = e => rej(e); }); }
  async function idbGet(key){ if(!db) await openDB(); return new Promise((res,rej)=>{ const tx = db.transaction(DB_STORE,'readonly'); const st = tx.objectStore(DB_STORE); const rq = st.get(key); rq.onsuccess = ()=> res(rq.result ? rq.result.val : null); rq.onerror = e => rej(e); }); }

  // BroadcastChannel for cross-tab sync
  let bc = null;
  if('BroadcastChannel' in window) try{ bc = new BroadcastChannel('lexi_channel'); bc.onmessage = (m) => { if(m.data && m.data.type==='state') { state = m.data.state; applyStateToUI(); } }; }catch(e){ bc=null; }

  function broadcastState(){ if(bc) bc.postMessage({type:'state', state}); }

  // Undo / redo (simple)
  let undoStack = [], redoStack = [];
  function pushUndo(){ undoStack.push(JSON.parse(JSON.stringify(state))); if(undoStack.length>100) undoStack.shift(); redoStack = []; }
  function undo(){ if(!undoStack.length) return; redoStack.push(JSON.parse(JSON.stringify(state))); state = undoStack.pop(); applyStateToUI(); idbPut('state', state); broadcastState(); }
  function redo(){ if(!redoStack.length) return; undoStack.push(JSON.parse(JSON.stringify(state))); state = redoStack.pop(); applyStateToUI(); idbPut('state', state); broadcastState(); }

  // Helpers: show/hide modals
  function openModal(id){ const el = document.getElementById(id); if(!el) return; el.classList.add('open'); el.style.display='flex'; el.classList.remove('hidden'); }
  function closeModal(id){ const el = document.getElementById(id); if(!el) return; el.classList.remove('open'); el.style.display='none'; el.classList.add('hidden'); }

  // Save/Load state
  async function saveAll(){
    try{ await idbPut('state', state); localStorage.setItem('lexi_state', JSON.stringify(state)); broadcastState(); }catch(e){ localStorage.setItem('lexi_state', JSON.stringify(state)); }
  }
  async function loadAll(){
    try{
      await openDB();
      const saved = await idbGet('state');
      if(saved) state = saved;
      else {
        const ls = localStorage.getItem('lexi_state');
        if(ls) state = JSON.parse(ls);
        else await seedIfEmpty();
      }
    }catch(e){
      const ls = localStorage.getItem('lexi_state');
      if(ls) state = JSON.parse(ls);
      else await seedIfEmpty();
    }
  }
  async function seedIfEmpty(){
    if(!state) state = { transactions:[], bills:[], jobs:[], budgets:[], savings:[], events:[] };
    if(!state.jobs) state.jobs = [];
    if(!state.transactions) state.transactions = [];
    await idbPut('state', state);
  }

  // Small UI helpers & clock/quotes
  function updateClock(){
    const now = new Date(new Date().toLocaleString('en-US',{timeZone:TZ}));
    $('#manila-clock').textContent = now.toLocaleTimeString('en-PH',{hour:'numeric',minute:'2-digit',second:'2-digit',hour12:true});
    $('#manila-date').textContent = now.toLocaleDateString('en-PH',{weekday:'long', year:'numeric', month:'long', day:'numeric'});
  }
  setInterval(updateClock,1000); updateClock();

  const quotes = ["Keep going, Lexi! üêæ","Small savings, big dreams ‚ú®","Every peso counts üíñ","Budgeting = Freedom üí∞","You're doing great! üå∏"];
  let qi = 0;
  function rotateQuote(){ $('#motivational-quote').textContent = quotes[qi]; qi=(qi+1)%quotes.length; }
  // change quote every day at midnight Manila ‚Äî but for simplicity rotate every 10s while testing, will be daily when left running
  setInterval(rotateQuote,10000); rotateQuote();

  // Floating paw spawns
  function spawnPaw(){
    const d = document.createElement('div'); d.className='floating-paw'; d.textContent='üêæ';
    const left = Math.random()*100; const top = 100 + Math.random()*20;
    d.style.left = `${left}vw`; d.style.top = `${top}vh`;
    d.style.transition = 'transform 10s linear, opacity 10s linear';
    document.body.appendChild(d);
    requestAnimationFrame(()=> d.style.transform = `translateY(-140vh) rotate(${Math.random()*180-90}deg)`, d.style.opacity='0');
    setTimeout(()=> d.remove(),10000);
  }
  setInterval(spawnPaw,3500);

  /* ---------------- Renderers ---------------- */

  function renderTransactionsTable(filterText=''){
    const tbody = document.querySelector('#tx-table tbody'); if(!tbody) return; tbody.innerHTML='';
    const list = state.transactions.slice().sort((a,b)=> b.date.localeCompare(a.date));
    const filtered = filterText ? list.filter(t => JSON.stringify(t).toLowerCase().includes(filterText.toLowerCase())) : list;
    filtered.forEach(tx=>{
      const balAfter = computeBalanceAfter(tx);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="px-2 py-1">${formatDDMMYYYY(tx.date)}</td>
        <td class="px-2 py-1">${tx.type}</td>
        <td class="px-2 py-1">${tx.desc||''}</td>
        <td class="px-2 py-1">${tx.cat||''}</td>
        <td class="px-2 py-1">‚Ç±${currencyFmt(tx.amt)}</td>
        <td class="px-2 py-1">‚Ç±${currencyFmt(balAfter)}</td>
        <td class="px-2 py-1"><button data-edit-tx="${tx.id}" class="small text-pink-600">Edit</button> <button data-del-tx="${tx.id}" class="small text-red-600">Delete</button></td>`;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll('[data-del-tx]').forEach(btn=>btn.onclick = ()=>{ deleteTransaction(btn.dataset.delTx); });
    tbody.querySelectorAll('[data-edit-tx]').forEach(btn=>btn.onclick = ()=>{ openTxEditor(btn.dataset.editTx); });
  }

  function computeBalanceAfter(targetTx){
    const ordered = state.transactions.slice().sort((a,b)=> a.date.localeCompare(b.date));
    let bal = 0;
    for(const t of ordered){
      if(t.type==='income') bal += Number(t.amt||0);
      else bal -= Number(t.amt||0);
      if(t.id===targetTx.id) break;
    }
    return bal;
  }

  function renderSavings(){
    const cont = $('#savings-list'); if(!cont) return; cont.innerHTML='';
    state.savings.forEach(s=>{
      const pct = s.target ? Math.min(100, Math.round(100*Number(s.current||0)/Number(s.target||1))) : 0;
      const el = document.createElement('div'); el.className='p-2 border rounded mb-2';
      el.innerHTML = `<div class="flex justify-between"><div>${s.name}</div><div>‚Ç±${currencyFmt(s.current)} / ‚Ç±${currencyFmt(s.target)}</div></div>
        <div class="w-full bg-gray-100 h-2 rounded mt-2"><div style="width:${pct}%;height:100%;background:linear-gradient(90deg,#60a5fa,#7c3aed)"></div></div>
        <div class="mt-2 small"><button data-edit-saving="${s.id}" class="btn-outline small">Edit</button> <button data-del-saving="${s.id}" class="btn-outline small text-red-600">Delete</button></div>`;
      cont.appendChild(el);
    });
    cont.querySelectorAll('[data-del-saving]').forEach(b=>b.onclick = ()=>{ state.savings = state.savings.filter(x=>x.id!==b.dataset.delSaving); saveAll(); renderSavings(); renderDashboard(); });
    cont.querySelectorAll('[data-edit-saving]').forEach(b=>b.onclick = ()=>{ /* optional: open saving editor */ });
  }

  function renderJobsQuick(){
    const q = $('#salary-jobs-list'); if(!q) return; q.innerHTML='';
    state.jobs.forEach(j=>{
      const el = document.createElement('div'); el.className='p-3 border rounded mb-3';
      const payCycle = j.payCycle || j.paycycle || j.payCycle || 'monthly';
      el.innerHTML = `<div class="font-semibold">${j.company} ‚Äî ${j.role}</div>
        <div class="small">Salary: ‚Ç±${currencyFmt(j.salary)} ‚Ä¢ ${payCycle}</div>
        <div class="mt-2"><button data-open-job="${j.id}" class="btn-outline small">Open</button> <button data-del-job="${j.id}" class="btn-outline small text-red-600">Delete</button></div>`;
      q.appendChild(el);
    });
    q.querySelectorAll('[data-del-job]').forEach(b=>b.onclick = ()=>{ deleteJob(b.dataset.delJob); renderJobsQuick(); renderDashboard(); });
    q.querySelectorAll('[data-open-job]').forEach(b=>b.onclick = ()=>{ openJobEditor(b.dataset.openJob); });
  }

  function renderBillsList(){
    const cont = $('#panel-next-bills'); if(!cont) return; cont.innerHTML='';
    if(!state.bills || !state.bills.length) { cont.textContent = 'No bills'; return; }
    state.bills.slice().sort((a,b)=>a.day - b.day).forEach(b=>{
      const el = document.createElement('div'); el.className='small'; el.innerHTML = `${b.name} ‚Äî day ${b.day} ‚Ä¢ ‚Ç±${currencyFmt(b.amount)} <button data-edit-bill="${b.id}" class="btn-outline small">Edit</button> <button data-del-bill="${b.id}" class="btn-outline small text-red-600">Delete</button>`;
      cont.appendChild(el);
    });
    cont.querySelectorAll('[data-edit-bill]').forEach(b=>b.onclick = ()=> openBillEditor(b.dataset.editBill));
    cont.querySelectorAll('[data-del-bill]').forEach(b=>b.onclick = ()=>{ state.bills = state.bills.filter(x=>x.id!==b.dataset.delBill); saveAll(); renderBillsList(); });
  }

  // Dashboard render (summary, charts)
  let monthlyChart = null;
  function renderDashboard(){
    // compute totals
    const incomes = state.transactions.filter(t=>t.type==='income').reduce((s,x)=>s+Number(x.amt||0),0);
    const expenses = state.transactions.filter(t=>t.type==='expense').reduce((s,x)=>s+Number(x.amt||0),0);
    const savingsT = state.savings.reduce((s,x)=>s+Number(x.current||0),0);
    $('#panel-summary').innerHTML = `<div class="small"><strong>Income:</strong> ‚Ç±${currencyFmt(incomes)} ‚Ä¢ <strong>Expenses:</strong> ‚Ç±${currencyFmt(expenses)} ‚Ä¢ <strong>Savings:</strong> ‚Ç±${currencyFmt(savingsT)}</div>`;

    // upcoming paychecks: show computed paydates for jobs
    const payEl = $('#panel-paychecks'); if(payEl){
      payEl.innerHTML = '';
      state.jobs.forEach(j=>{
        const next = nextPayDateForJob(j);
        payEl.innerHTML += `<div class="small"> ${j.company} ‚Äî next pay: ${next} ‚Ä¢ ${j.payCycle || j.paycycle}</div>`;
      });
    }

    // recent tx
    const recent = state.transactions.slice().sort((a,b)=> b.date.localeCompare(a.date)).slice(0,5);
    $('#panel-recent-tx').innerHTML = recent.map(t=>`${formatDDMMYYYY(t.date)} ‚Ä¢ ${t.desc} ‚Ä¢ ‚Ç±${currencyFmt(t.amt)}`).join('<br>');

    // monthly chart
    renderMonthlyChart();
  }

  function renderMonthlyChart(){
    const ctx = document.getElementById('chart-monthly').getContext('2d');
    const now = new Date(new Date().toLocaleString('en-PH',{timeZone:TZ}));
    const labels = [], inc = [], exp = [], sav = [];
    for(let i=5;i>=0;i--){
      const d = new Date(now.getFullYear(), now.getMonth()-i,1);
      labels.push(d.toLocaleString('en-PH',{month:'short', year:'numeric'}));
      const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      inc.push(state.transactions.filter(t=>t.type==='income' && t.date && t.date.startsWith(ym)).reduce((s,x)=>s+Number(x.amt||0),0));
      exp.push(state.transactions.filter(t=>t.type==='expense' && t.date && t.date.startsWith(ym)).reduce((s,x)=>s+Number(x.amt||0),0));
      sav.push(state.savings.filter(s=>s.created && s.created.startsWith(ym)).reduce((s,x)=>s+Number(x.current||0),0));
    }
    if(monthlyChart) monthlyChart.destroy();
    monthlyChart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets:[
        { label: 'Income', data: inc, stack:'a' },
        { label: 'Expenses', data: exp, stack:'a' },
        { label: 'Savings', data: sav, stack:'a' }
      ] },
      options: { responsive:true, interaction:{mode:'index', intersect:false}, plugins:{legend:{position:'top'}} }
    });
  }

  /* ---------------- CRUD flows ---------------- */

  // Transactions
  let editingTxId = null;
  $('#add-tx-btn')?.addEventListener('click', ()=> {
    editingTxId = null;
    $('#tx-form-date').value = todayISO();
    $('#tx-form-type').value='income';
    $('#tx-form-desc').value=''; $('#tx-form-cat').value=''; $('#tx-form-amt').value=''; $('#tx-form-notes').value='';
    $('#tx-delete-btn').classList.add('hidden');
    openModal('modal-transaction');
  });

  $('#tx-cancel-btn')?.addEventListener('click', ()=> closeModal('modal-transaction'));

  $('#tx-save-btn')?.addEventListener('click', ()=> {
    const tx = {
      id: editingTxId || crypto.randomUUID(),
      date: $('#tx-form-date').value || todayISO(),
      desc: $('#tx-form-desc').value || '',
      cat: $('#tx-form-cat').value || 'Misc',
      amt: Math.abs(Number($('#tx-form-amt').value) || 0),
      type: $('#tx-form-type').value || 'income',
      notes: $('#tx-form-notes').value || '',
      created: new Date().toISOString()
    };
    // if saving as saving/goal, route into savings
    if(tx.type === 'saving'){
      const s = { id: crypto.randomUUID(), name: tx.desc || 'Goal', target: tx.amt || 0, current:0, created: (new Date()).toISOString() };
      state.savings.push(s);
    } else {
      if(editingTxId){
        const i = state.transactions.findIndex(t=>t.id===editingTxId);
        if(i>-1) state.transactions[i] = tx;
      } else state.transactions.push(tx);
    }
    saveAll();
    closeModal('modal-transaction');
    renderTransactionsTable();
    renderSavings();
    renderDashboard();
  });

  $('#tx-delete-btn')?.addEventListener('click', ()=> {
    if(!editingTxId) return;
    if(!confirm('Delete transaction?')) return;
    state.transactions = state.transactions.filter(t=>t.id!==editingTxId);
    saveAll(); closeModal('modal-transaction'); renderTransactionsTable(); renderDashboard();
  });

  function openTxEditor(id){
    const tx = state.transactions.find(t=>t.id===id); if(!tx) return;
    editingTxId = id;
    $('#tx-form-date').value = tx.date || todayISO();
    $('#tx-form-type').value = tx.type || 'expense';
    $('#tx-form-desc').value = tx.desc || '';
    $('#tx-form-cat').value = tx.cat || '';
    $('#tx-form-amt').value = tx.amt || '';
    $('#tx-form-notes').value = tx.notes || '';
    $('#tx-delete-btn').classList.remove('hidden');
    openModal('modal-transaction');
  }

  function deleteTransaction(id){
    if(!confirm('Delete transaction?')) return;
    state.transactions = state.transactions.filter(t=>t.id!==id);
    saveAll(); renderTransactionsTable(); renderDashboard();
  }

  // Jobs
  let editingJobId = null;
  $('#add-job-btn')?.addEventListener('click', ()=> {
    editingJobId = null;
    $('#job-form-company').value = ''; $('#job-form-role').value=''; $('#job-form-salary').value=''; $('#job-form-paycycle').value='biweekly'; $('#job-form-fulltime').checked = true;
    $('#job-delete-btn').classList.add('hidden'); openModal('modal-job');
  });
  $('#job-cancel-btn')?.addEventListener('click', ()=> closeModal('modal-job'));
  $('#job-save-btn')?.addEventListener('click', ()=> {
    const j = { id: editingJobId || crypto.randomUUID(), company: $('#job-form-company').value||'Job', role: $('#job-form-role').value||'', salary: Number($('#job-form-salary').value)||0, payCycle: $('#job-form-paycycle').value||'monthly', fulltime: $('#job-form-fulltime').checked };
    if(editingJobId){
      const i = state.jobs.findIndex(x=>x.id===editingJobId); if(i>-1) state.jobs[i] = j;
    } else state.jobs.push(j);
    saveAll(); closeModal('modal-job'); renderJobsQuick(); renderDashboard();
  });
  $('#job-delete-btn')?.addEventListener('click', ()=> {
    if(!editingJobId) return; if(!confirm('Delete job?')) return; state.jobs = state.jobs.filter(j=>j.id!==editingJobId); saveAll(); closeModal('modal-job'); renderJobsQuick(); renderDashboard();
  });

  function openJobEditor(id){
    const j = state.jobs.find(x=>x.id===id); if(!j) return;
    editingJobId = id; $('#job-form-company').value = j.company; $('#job-form-role').value = j.role; $('#job-form-salary').value = j.salary; $('#job-form-paycycle').value = j.payCycle || 'monthly'; $('#job-delete-btn').classList.remove('hidden'); openModal('modal-job');
  }

  function deleteJob(id){ if(!confirm('Delete job?')) return; state.jobs = state.jobs.filter(j=>j.id!==id); saveAll(); renderJobsQuick(); renderDashboard(); }

  // Bills
  let editingBillId = null;
  $('#add-bill-btn')?.addEventListener('click', ()=> { editingBillId=null; $('#bill-form-name').value=''; $('#bill-form-day').value='1'; $('#bill-form-amt').value=''; $('#bill-form-auto').checked=false; $('#bill-delete-btn').classList.add('hidden'); openModal('modal-bill');});
  $('#bill-cancel-btn')?.addEventListener('click', ()=> closeModal('modal-bill'));
  $('#bill-save-btn')?.addEventListener('click', ()=> {
    const b = { id: editingBillId||crypto.randomUUID(), name: $('#bill-form-name').value||'Bill', day: Number($('#bill-form-day').value)||1, amount: Number($('#bill-form-amt').value)||0, auto: $('#bill-form-auto').checked||false };
    if(editingBillId){ const i = state.bills.findIndex(x=>x.id===editingBillId); if(i>-1) state.bills[i]=b; } else state.bills.push(b);
    saveAll(); closeModal('modal-bill'); renderBillsList(); renderDashboard();
  });
  $('#bill-delete-btn')?.addEventListener('click', ()=> { if(!editingBillId) return; if(!confirm('Delete bill?')) return; state.bills = state.bills.filter(b=>b.id!==editingBillId); saveAll(); closeModal('modal-bill'); renderBillsList(); renderDashboard(); });
  function openBillEditor(id){ const b = state.bills.find(x=>x.id===id); if(!b) return; editingBillId = id; $('#bill-form-name').value=b.name; $('#bill-form-day').value=b.day; $('#bill-form-amt').value=b.amount; $('#bill-form-auto').checked = b.auto; $('#bill-delete-btn').classList.remove('hidden'); openModal('modal-bill'); }

  // Events / Calendar
  let calendarDate = new Date(new Date().toLocaleString('en-PH',{timeZone:TZ}));
  function renderCalendar(){
    const grid = $('#calendar-grid'); if(!grid) return; grid.innerHTML='';
    const year = calendarDate.getFullYear(), month = calendarDate.getMonth();
    $('#calendar-month-label').textContent = calendarDate.toLocaleString('en-PH',{month:'long', year:'numeric'});
    const firstWeekday = new Date(year, month, 1).getDay();
    for(let i=0;i<firstWeekday;i++) grid.appendChild(document.createElement('div'));
    const days = new Date(year, month+1, 0).getDate();
    for(let d=1; d<=days; d++){
      const iso = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const cell = document.createElement('div'); cell.className='p-2 border rounded bg-white';
      const todays = state.events.filter(ev=>ev.date===iso);
      const chipsHtml = todays.map(ev=>`<div class="calendar-chip ${chipClassFor(ev)}" data-ev-id="${ev.id}">${ev.emoji||''} ${ev.title}</div>`).join('');
      cell.innerHTML = `<div class="font-semibold text-sm">${String(d).padStart(2,'0')}</div><div class="mt-2">${chipsHtml}</div>`;
      cell.onclick = (e)=> {
        if(e.target && e.target.matches('.calendar-chip')){ const id = e.target.dataset.evId; const ev = state.events.find(x=>x.id===id); if(ev) openEventEditor(ev); return; }
        openNewEvent(iso);
      };
      grid.appendChild(cell);
    }
  }
  $('#prev-month').addEventListener('click', ()=>{ calendarDate.setMonth(calendarDate.getMonth()-1); renderCalendar(); });
  $('#next-month').addEventListener('click', ()=>{ calendarDate.setMonth(calendarDate.getMonth()+1); renderCalendar(); });

  function chipClassFor(ev){ const t=(ev.title||'').toLowerCase(); if(/bill|due|payment/.test(t)) return 'chip-bill'; if(/salary|payday|payout/.test(t)) return 'chip-pay'; if(/birthday/.test(t)) return 'chip-bday'; if(/meeting|interview/.test(t)) return 'chip-meet'; return 'chip-default'; }

  let editingEventId = null;
  function openNewEvent(dateISO){ editingEventId = null; $('#event-form-title').value=''; $('#event-form-emoji').value=''; $('#event-form-notes').value=''; $('#event-form-date').value = dateISO; $('#event-delete-btn').classList.add('hidden'); openModal('modal-event'); }
  function openEventEditor(ev){ editingEventId = ev.id; $('#event-form-title').value = ev.title; $('#event-form-emoji').value = ev.emoji||''; $('#event-form-notes').value = ev.notes||''; $('#event-form-date').value = ev.date; $('#event-delete-btn').classList.remove('hidden'); openModal('modal-event'); }
  $('#event-cancel-btn')?.addEventListener('click', ()=> closeModal('modal-event'));
  $('#event-save-btn')?.addEventListener('click', ()=> {
    const title = $('#event-form-title').value.trim(); const date = $('#event-form-date').value; const emoji = $('#event-form-emoji').value.trim(); const notes = $('#event-form-notes').value.trim();
    if(!title || !date){ alert('Please add title and date'); return; }
    if(editingEventId){
      const i = state.events.findIndex(x=>x.id===editingEventId); if(i>-1) state.events[i] = { id:editingEventId, title, emoji, notes, date };
    } else state.events.push({ id: crypto.randomUUID(), title, emoji, notes, date });
    saveAll(); closeModal('modal-event'); renderCalendar(); renderDashboard();
  });
  $('#event-delete-btn')?.addEventListener('click', ()=> { if(!editingEventId) return; if(!confirm('Delete event?')) return; state.events = state.events.filter(x=>x.id!==editingEventId); saveAll(); closeModal('modal-event'); renderCalendar(); });

  /* ---------------- Paycheck logic ---------------- */

  // Given a date (string or Date), return {start,end,payDateISO} for bi-weekly rule
  function computeBiweeklyPayPeriod(date){
    const d = (typeof date === 'string') ? new Date(date+'T00:00:00') : new Date(date);
    const y = d.getFullYear(), m = d.getMonth();
    const day = d.getDate();
    let startISO, endISO, payDate;
    const daysInMonth = new Date(y,m+1,0).getDate();
    if(day <= 15){
      startISO = `${y}-${String(m+1).padStart(2,'0')}-01`;
      endISO = `${y}-${String(m+1).padStart(2,'0')}-15`;
      payDate = new Date(y, m, daysInMonth); // end of month
    } else {
      startISO = `${y}-${String(m+1).padStart(2,'0')}-16`;
      endISO = `${y}-${String(m+1).padStart(2,'0')}-${String(daysInMonth).padStart(2,'0')}`;
      payDate = new Date(y, m+1, 15); // 15th of next month
    }
    return { startISO, endISO, payDateISO: payDate.toISOString().split('T')[0] };
  }

  // Generic: compute pay period for job depending on payCycle
  function computePayPeriodForJob(job, forDate){
    const d = forDate ? new Date(forDate) : new Date(new Date().toLocaleString('en-PH',{timeZone:TZ}));
    if(job.payCycle === 'biweekly') return computeBiweeklyPayPeriod(d);
    if(job.payCycle === 'weekly'){
      // week starting Monday
      const day = d.getDay(); const diff = (day + 6) % 7; // days since monday
      const s = new Date(d); s.setDate(d.getDate()-diff);
      const e = new Date(s); e.setDate(s.getDate()+6);
      const payDate = new Date(e); payDate.setDate(e.getDate()+1); // pay next day
      return { startISO: s.toISOString().split('T')[0], endISO: e.toISOString().split('T')[0], payDateISO: payDate.toISOString().split('T')[0] };
    }
    // monthly
    const y = d.getFullYear(), m = d.getMonth();
    const start = `${y}-${String(m+1).padStart(2,'0')}-01`;
    const days = new Date(y,m+1,0).getDate();
    const end = `${y}-${String(m+1).padStart(2,'0')}-${String(days).padStart(2,'0')}`;
    const pay = new Date(y,m,days);
    return { startISO: start, endISO: end, payDateISO: pay.toISOString().split('T')[0] };
  }

  // compute simple expected paycheck (monthly salary prorated by days in period)
  function computePaycheckForJobPreview(job, forDate){
    const p = computePayPeriodForJob(job, forDate);
    const s = new Date(p.startISO); const e = new Date(p.endISO);
    const daysInPeriod = ( (e - s) / (1000*60*60*24) ) + 1;
    // monthly salary -> daily estimate
    const monthDays = new Date(s.getFullYear(), s.getMonth()+1, 0).getDate();
    const daily = Number(job.salary||0) / monthDays;
    const expected = daily * daysInPeriod;
    return { startISO: p.startISO, endISO: p.endISO, payDateISO: p.payDateISO, expected: Math.round(expected*100)/100, daily };
  }

  let lastComputedPaycheck = null;
  $('#compute-paycheck-btn')?.addEventListener('click', ()=>{
    // if jobs exist, compute first job preview (or combine all)
    if(!state.jobs.length) return alert('No jobs found');
    const job = state.jobs[0];
    const res = computePaycheckForJobPreview(job);
    lastComputedPaycheck = { jobId: job.id, ...res };
    const preview = $('#paystub-preview'); preview.innerHTML = `<div><strong>${job.company}</strong> ‚Äî ${job.role}</div><div class="small">Pay Period: ${formatDDMMYYYY(res.startISO)} ‚Äî ${formatDDMMYYYY(res.endISO)}</div><div class="mt-2 small"><strong>Expected Amount:</strong> ‚Ç±${currencyFmt(res.expected)}</div>`;
    // compare with actual transactions
    const actual = state.transactions.filter(t=>t.type==='income' && t.date>=res.startISO && t.date<=res.endISO && (t.linked===job.id || t.cat==='Job' || t.desc?.includes(job.company))).reduce((s,x)=>s+Number(x.amt||0),0);
    $('#paycheck-compare').innerHTML = `Expected: ‚Ç±${currencyFmt(res.expected)} ‚Ä¢ Actual: ‚Ç±${currencyFmt(actual)} ‚Ä¢ Diff: ‚Ç±${currencyFmt(actual - res.expected)}`;
  });

  $('#sync-paycheck-btn')?.addEventListener('click', ()=>{
    if(!lastComputedPaycheck) return alert('Compute paycheck first');
    const job = state.jobs.find(j=>j.id===lastComputedPaycheck.jobId); if(!job) return;
    const tx = { id: crypto.randomUUID(), date: lastComputedPaycheck.endISO, desc: `${job.company} ‚Äî Paycheck (${formatDDMMYYYY(lastComputedPaycheck.startISO)} - ${formatDDMMYYYY(lastComputedPaycheck.endISO)})`, cat:'Job', amt: Number(lastComputedPaycheck.expected), type:'income', notes:'Auto-synced paycheck', created: (new Date()).toISOString(), linked: job.id };
    state.transactions.push(tx); saveAll(); renderTransactionsTable(); renderDashboard(); alert('Paycheck synced (planned). Mark actual when deposited.');
  });

  function nextPayDateForJob(job){
    const now = new Date(new Date().toLocaleString('en-PH',{timeZone:TZ}));
    const p = computePayPeriodForJob(job, now);
    return p.payDateISO;
  }

  /* ---------------- Charts scheduling ---------------- */
  let chartTimer = null;
  function scheduleChartsUpdate(){ if(chartTimer) clearTimeout(chartTimer); chartTimer = setTimeout(()=>{ renderDashboard(); }, DEBOUNCE_MS); }

  /* ---------------- Boot flows, wiring, events ---------------- */

  // Tab switching
  $$('button[data-panel]').forEach(b=>{
    b.addEventListener('click', ()=>{
      $$('button[data-panel]').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      const p = b.dataset.panel;
      $$('main section').forEach(s=>s.classList.add('hidden'));
      const sel = document.getElementById(p);
      if(sel) sel.classList.remove('hidden');
      // re-render calendars if needed
      if(p==='panel-calendar') renderCalendar();
    });
  });

  // search
  $('#global-search')?.addEventListener('input', (e)=> renderTransactionsTable(e.target.value));

  // quick add saving
  $('#add-saving-btn')?.addEventListener('click', ()=> {
    const name = prompt('Saving name?'); if(!name) return;
    const target = Number(prompt('Target amount (PHP)')||0);
    state.savings.push({ id: crypto.randomUUID(), name, target, current:0, created: todayISO() });
    saveAll(); renderSavings(); renderDashboard();
  });

  // profile save
  $('#profile-save-btn')?.addEventListener('click', ()=> {
    alert('Profile saved');
    // in future persist profile to state
  });

  // wiring startup save loop & SW
  async function boot(){
    try{ await openDB(); }catch(e){ console.warn('IndexedDB error', e); }
    const saved = await idbGet('state');
    if(saved) state = saved;
    else {
      const ls = localStorage.getItem('lexi_state');
      if(ls) state = JSON.parse(ls);
      else state = state; // keep empty
    }
    applyStateToUI();
    // autosave every 5s
    setInterval(()=> idbPut('state', state), 5000);

    if('Notification' in window && Notification.permission === 'default') try{ await Notification.requestPermission(); }catch(e){}
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('/lexi-sw.js').then(reg => {
        reg.addEventListener('updatefound', ()=>{ const newSW = reg.installing; newSW.addEventListener('statechange', ()=>{ if(newSW.state==='installed'){ if(bc) bc.postMessage({type:'sw-update'}); else showUpdateBanner(); } }); });
      }).catch(()=>console.warn('SW register failed'));
      navigator.serviceWorker?.addEventListener && navigator.serviceWorker.addEventListener('message', (ev)=>{ if(ev.data==='reload'){ showUpdateBanner(); } });
    }
  }

  function showUpdateBanner(){
    const b = document.createElement('div'); b.style.position='fixed'; b.style.bottom='16px'; b.style.left='50%'; b.style.transform='translateX(-50%)'; b.style.background='linear-gradient(90deg,#fff1f6,#ffe6f2)'; b.style.color='#7b1b4b'; b.style.padding='8px 12px'; b.style.borderRadius='12px'; b.style.boxShadow='0 6px 20px rgba(0,0,0,0.08)'; b.style.zIndex=9999; b.textContent = 'Lexi updated ‚ú® refreshing...'; document.body.appendChild(b); setTimeout(()=>{ try{ location.reload(); }catch(e){} }, 900);
  }

  // Apply state to UI
  function applyStateToUI(){
    renderTransactionsTable();
    renderBillsList();
    renderJobsQuick();
    renderSavings();
    renderCalendar();
    renderDashboard();
  }

  // Load then boot
  loadAll().then(()=> boot());

  // Expose some helpers for debugging
  window.lexi = { state, saveAll, computeBiweeklyPayPeriod };

})();
</script>

</body>
</html>
